<!DOCTYPE html>
<html lang="en">
    <link rel="icon" href="cdl.png">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Score - Crawley Darts League</title>
    <link rel="stylesheet" href="styles.css">
    <style>
:root {
    --primary: #1a237e;
    --secondary: #3949ab;
    --light-gray: #f5f5f5;
    --medium-gray: #e0e0e0;
    --dark-gray: #757575;
    --card-bg: #ffffff;
}

/* Header Styles */
.header {
    background: linear-gradient(135deg, var(--primary), var(--secondary));
    color: white;
    padding: 15px 20px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    display: flex;
    justify-content: center;
    align-items: center;
    position: relative;
}

.logo-container {
    position: absolute;
    right: 20px;
    top: 50%;
    transform: translateY(-50%);
}

.logo {
    width: 70px;
    height: 67px;
    object-fit: contain;
}

.header h1 {
    margin: 0;
    text-align: center;
    font-size: 1.5rem;
}

/* Navigation Styles */
.nav {
    background-color: white;
    position: relative;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.nav-menu {
    list-style: none;
    padding: 0;
    margin: 0;
    display: flex;
    justify-content: center;
}

.nav-menu > li {
    position: relative;
    margin: 0;
}

.nav-menu > li > a {
    display: block;
    padding: 15px;
    color: var(--primary);
    text-decoration: none;
    font-weight: 500;
    transition: all 0.3s ease;
}

.nav-menu > li > a:hover {
    background-color: var(--light-gray);
}

/* Dropdown Menu */
.dropdown {
    position: relative;
}

.dropdown-toggle:after {
    content: "▼";
    font-size: 0.7em;
    margin-left: 5px;
    vertical-align: middle;
}

.dropdown-menu {
    position: absolute;
    top: 100%;
    left: 0;
    background-color: white;
    min-width: 200px;
    padding: 5px 0;
    margin: 0;
    list-style: none;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    border-radius: 0 0 4px 4px;
    z-index: 100;
    opacity: 0;
    visibility: hidden;
    transform: translateY(10px);
    transition: all 0.3s ease;
}

.dropdown:hover .dropdown-menu,
.dropdown:focus-within .dropdown-menu,
.dropdown-menu:hover {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
}

.dropdown-menu li {
    margin: 0;
}

.dropdown-menu a {
    display: block;
    padding: 10px 15px;
    color: var(--primary);
    text-decoration: none;
    transition: all 0.3s ease;
}

.dropdown-menu a:hover {
    background-color: var(--light-gray);
}

/* Mobile Toggle Button */
.mobile-toggle {
    display: none;
    background: transparent;
    border: none;
    cursor: pointer;
    padding: 10px;
    position: absolute;
    left: 20px;
    top: 50%;
    transform: translateY(-50%);
    z-index: 10;
}

.mobile-toggle .bar {
    display: block;
    width: 25px;
    height: 3px;
    margin: 5px auto;
    background-color: white;
    transition: all 0.3s ease;
}

/* Media Queries for Responsive Design */
@media screen and (max-width: 992px) {
    .nav-menu {
        justify-content: flex-start;
    }
    
    .nav-menu > li > a {
        padding: 15px 10px;
        font-size: 0.9rem;
    }
}

@media screen and (max-width: 768px) {
    .header h1 {
        font-size: 1.3rem;
    }
    
    .mobile-toggle {
        display: block;
    }
    
    .nav-menu {
        flex-direction: column;
        position: absolute;
        top: 100%;
        left: 0;
        width: 100%;
        background-color: white;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.5s ease;
        z-index: 100;
    }
    
    .nav-menu.active {
        max-height: 1000px;
    }
    
    .dropdown-menu {
        position: static;
        box-shadow: none;
        opacity: 1;
        visibility: visible;
        transform: none;
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease;
    }
    
    .dropdown.active .dropdown-menu {
        max-height: 500px;
    }
    
    .dropdown-toggle:after {
        float: right;
    }
    
    .dropdown.active .dropdown-toggle:after {
        content: "▲";
    }
    
    .nav-menu > li {
        border-bottom: 1px solid var(--light-gray);
    }
    
    .dropdown-menu li {
        background-color: var(--light-gray);
        padding-left: 15px;
    }
}

@media screen and (max-width: 480px) {
    .header h1 {
        font-size: 1.1rem;
    }
    
    .logo {
        width: 50px;
        height: 48px;
    }
}


                /* Custom header style for the index page to position logo left and title centered */
                .header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .logo-container {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
        }
        
        .logo {
            width: 70px;
            height: 67px;
            object-fit: contain;
        }
        
        .header h1 {
            margin: 0;
            text-align: center;
        }
        /* Additional styles specifically for edit page */
        #edit-cup-round-container.disabled-field {
            opacity: 0.6;
            pointer-events: none;
        }
        
        #edit-cup-round-container {
            transition: opacity 0.3s ease;
        }
        
        /* Loading indicator styles */
        #loading-indicator {
            padding: 15px;
            background-color: #f0f8ff;
            color: var(--primary);
            border-radius: 5px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            animation: pulse 1.5s infinite;
        }
        
        /* Team info section */
        .team-info {
            background-color: #e8f5e9;
            padding: 10px 15px;
            margin-bottom: 20px;
            border-radius: 5px;
            border-left: 4px solid var(--success);
            font-size: 0.95em;
        }
        
        .team-info p {
            margin: 0;
        }
        /* Basic dropdown styling */
.nav .dropdown {
    position: relative;
}

.nav .dropdown-toggle {
    cursor: pointer;
}

.nav .dropdown-menu {
    display: none;
    position: absolute;
    background: white;
    min-width: 200px;
    box-shadow: 0 8px 16px rgba(0,0,0,0.1);
    z-index: 1000;
    border-radius: 4px;
    padding: 10px 0;
}

.nav .dropdown:hover .dropdown-menu {
    display: block;
}

.nav .dropdown-menu li {
    margin: 0;
    padding: 0;
}

.nav .dropdown-menu a {
    display: block;
    padding: 10px 20px;
    color: var(--primary);
    border-radius: 0;
}

.nav .dropdown-menu a:hover {
    background-color: var(--light-gray);
}

/* Mobile navigation */
.mobile-nav-toggle {
    display: none;
    cursor: pointer;
    padding: 10px;
    font-size: 1.5rem;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .mobile-nav-toggle {
        display: block;
    }
    
    .nav-menu {
        display: none;
        position: absolute;
        top: 100%;
        left: 0;
        width: 100%;
        background: white;
        box-shadow: 0 5px 10px rgba(0,0,0,0.1);
        z-index: 1000;
        padding: 0;
        margin: 0;
    }
    
    .nav-menu.active {
        display: block;
    }
    
    .nav-menu li {
        margin: 0;
        padding: 0;
        display: block;
        border-bottom: 1px solid var(--light-gray);
    }
    
    .nav-menu a {
        padding: 15px 20px;
        display: block;
    }
    
    .nav .dropdown-menu {
        position: static;
        box-shadow: none;
        background: var(--light-gray);
        width: 100%;
        padding: 0;
    }
    
    .nav .dropdown-menu li:first-child {
        border-top: 1px solid var(--medium-gray);
    }
    
    .nav .dropdown:hover .dropdown-menu {
        display: none; /* Don't show on hover on mobile */
    }
    
    /* Add a + icon to dropdowns */
    .nav .dropdown-toggle::after {
        content: "+";
        margin-left: 5px;
    }
    
    /* Toggle this class with JavaScript */
    .nav .dropdown.active .dropdown-menu {
        display: block;
    }
    
    .nav .dropdown.active .dropdown-toggle::after {
        content: "-";
    }
}
    </style>
</head>
<body>
<header class="header">
    <div class="logo-container">
        <img src="cdl-logo.png" alt="Crawley Darts League Logo" class="logo">
    </div>
    <h1>Crawley Darts League</h1>
    <button class="mobile-toggle" aria-label="Toggle menu">
        <span class="bar"></span>
        <span class="bar"></span>
        <span class="bar"></span>
    </button>
</header>

<nav class="nav">
    <ul class="nav-menu">
        <li><a href="index.html">Home</a></li>
        
        <li class="dropdown">
            <a href="#" class="dropdown-toggle">League</a>
            <ul class="dropdown-menu">
                <li><a href="leaguetable.html">League Table</a></li>
                <li><a href="leaguefixtures.html">Fixtures</a></li>
                <li><a href="leagueresults.html">Results</a></li>
            </ul>
        </li>
        
        <li class="dropdown">
            <a href="#" class="dropdown-toggle">Cup</a>
            <ul class="dropdown-menu">
                <li><a href="cupfixtures.html">Fixtures</a></li>
                <li><a href="cupresults.html">Results</a></li>
                <li><a href="cupdraw.html">Cup Draw</a></li>
            </ul>
        </li>
        
        <li class="dropdown">
            <a href="#" class="dropdown-toggle">Statistics</a>
            <ul class="dropdown-menu">
                <li><a href="180sfinishes.html">180s & High Finishes</a></li>
                <li><a href="playerrankings.html">Player Rankings</a></li>
            </ul>
        </li>
        
        <li class="dropdown">
            <a href="#" class="dropdown-toggle">Information</a>
            <ul class="dropdown-menu">
                <li><a href="contactinfo.html">Contacts & Venues</a></li>
                <li><a href="rules.html">League Rules</a></li>
                <li><a href="agm-minutes.html">AGM Minutes</a></li>
                <li><a href="players.html">Players</a></li>
            </ul>
        </li>
        
        <li class="dropdown">
            <a href="#" class="dropdown-toggle">Submit Score</a>
            <ul class="dropdown-menu">
                <li><a href="scoreinput.html">Submit Score</a></li>
                <li><a href="editscores.html">Edit Score</a></li>
            </ul>
        </li>

        <li class="dropdown">
            <a href="#" class="dropdown-toggle">Join</a>
            <ul class="dropdown-menu">
                <li><a href="registration.html">Registration Form</a></li>
            </ul>
        </li>
    </ul>
    </nav>    <div class="container">
        <!-- Edit Score Page -->
        <div id="edit-scores" class="page">
            <div id="loading-indicator" class="hidden">Processing...</div>
            
            <div id="edit-login-form" class="card login-form">
                <h2>Edit Score Login</h2>
                <form id="edit-login-form-element">
                    <div class="form-group">
                        <label for="edit-username">Username</label>
                        <input type="text" id="edit-username" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-password">Password</label>
                        <input type="password" id="edit-password" required>
                    </div>
                    <button type="submit" class="btn">Login</button>
                </form>
            </div>

            <div id="edit-scores-container" class="card hidden">
                <h2>Edit Match Scores</h2>
                <div id="team-info" class="team-info">
                    <!-- Team info will be displayed here -->
                </div>
                
                <div class="form-group">
                    <label for="match-select">Select Match to Edit</label>
                    <select id="match-select">
                        <option value="">Select a match...</option>
                    </select>
                </div>
                
                <div id="edit-match-form-container" class="hidden">
                    <div id="loading-indicator" class="hidden">Loading match details...</div>
                    <form id="edit-match-form">
                        <div class="form-group">
                            <label for="edit-match-type">Match Type</label>
                            <select id="edit-match-type" disabled>
                                <option value="league">League</option>
                                <option value="cup">Cup</option>
                            </select>
                        </div>
                        <div class="form-group" id="edit-cup-round-container">
                            <label for="edit-cup-round">Cup Round</label>
                            <select id="edit-cup-round" disabled>
                                <option value="">Select Cup Round</option>
                                <option value="Last 16">Last 16</option>
                                <option value="Quarter Final">Quarter Final</option>
                                <option value="Semi Final">Semi Final</option>
                                <option value="Final">Final</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="edit-home-team">Home Team</label>
                            <select id="edit-home-team" disabled>
                                <!-- Team options will be loaded dynamically -->
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="edit-away-team">Away Team</label>
                            <select id="edit-away-team" disabled>
                                <!-- Team options will be loaded dynamically -->
                            </select>
                        </div>
                        
                        <h3>Doubles Matches (3 games)</h3>
                        <div id="edit-doubles-matches">
                            <!-- Doubles match inputs will be generated dynamically -->
                        </div>
                        
                        <h3>Singles Matches (6 games)</h3>
                        <div id="edit-singles-matches">
                            <!-- Singles match inputs will be generated dynamically -->
                        </div>
                        
                        <h3>180s</h3>
                        <div id="edit-one-eighties-section" class="stats-section">
                            <!-- 180s inputs will be generated dynamically -->
                        </div>
                        
                        <h3>High Finishes</h3>
                        <div id="edit-high-finishes-section" class="stats-section">
                            <!-- High finishes inputs will be generated dynamically -->
                        </div>
                        
                        <button type="submit" class="btn">Update Score</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
document.addEventListener('DOMContentLoaded', function() {
    const mobileToggle = document.querySelector('.mobile-toggle');
    const navMenu = document.querySelector('.nav-menu');
    const dropdownToggles = document.querySelectorAll('.dropdown-toggle');
    
    // Toggle mobile menu
    mobileToggle.addEventListener('click', function() {
        navMenu.classList.toggle('active');
        
        // Animate hamburger to X
        this.classList.toggle('active');
        const bars = this.querySelectorAll('.bar');
        if (this.classList.contains('active')) {
            bars[0].style.transform = 'rotate(-45deg) translate(-5px, 6px)';
            bars[1].style.opacity = '0';
            bars[2].style.transform = 'rotate(45deg) translate(-5px, -6px)';
        } else {
            bars[0].style.transform = 'none';
            bars[1].style.opacity = '1';
            bars[2].style.transform = 'none';
        }
    });
    
    // Handle dropdown menus on mobile
    dropdownToggles.forEach(toggle => {
        toggle.addEventListener('click', function(e) {
            // Only apply this behavior on mobile
            if (window.innerWidth <= 768) {
                e.preventDefault();
                const parentLi = this.parentElement;
                
                // Close all other open dropdowns
                document.querySelectorAll('.dropdown.active').forEach(item => {
                    if (item !== parentLi) {
                        item.classList.remove('active');
                    }
                });
                
                // Toggle this dropdown
                parentLi.classList.toggle('active');
            }
        });
    });
    
    // Close menu when clicking outside
    document.addEventListener('click', function(e) {
        const isClickInsideNav = navMenu.contains(e.target) || mobileToggle.contains(e.target);
        if (!isClickInsideNav && navMenu.classList.contains('active')) {
            navMenu.classList.remove('active');
            mobileToggle.classList.remove('active');
            const bars = mobileToggle.querySelectorAll('.bar');
            bars[0].style.transform = 'none';
            bars[1].style.opacity = '1';
            bars[2].style.transform = 'none';
        }
    });
    
    // Handle resize events
    window.addEventListener('resize', function() {
        if (window.innerWidth > 768) {
            navMenu.classList.remove('active');
            mobileToggle.classList.remove('active');
            const bars = mobileToggle.querySelectorAll('.bar');
            bars[0].style.transform = 'none';
            bars[1].style.opacity = '1';
            bars[2].style.transform = 'none';
            
            // Reset all dropdowns
            document.querySelectorAll('.dropdown.active').forEach(item => {
                item.classList.remove('active');
            });
        }
    });
});
        // API configuration
        const API_URL = 'api.php'; // Change this to your actual API endpoint

        // Global variables to store captain information
        let currentCaptain = null;
        let captainDivision = null;

        // API functions
        async function fetchApi(endpoint, params = {}) {
            const queryString = new URLSearchParams(params).toString();
            const url = `${API_URL}?endpoint=${endpoint}&${queryString}`;
            
            try {
                const response = await fetch(url);
                return await response.json();
            } catch (error) {
                console.error('API Error:', error);
                return [];
            }
        }

        async function postApi(endpoint, data) {
            try {
                console.log(`Sending ${endpoint} request:`, data);
                
                const loadingIndicator = document.getElementById('loading-indicator');
                if (loadingIndicator) loadingIndicator.classList.remove('hidden');
                
                const response = await fetch(`${API_URL}?endpoint=${endpoint}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                const responseText = await response.text();
                
                if (loadingIndicator) loadingIndicator.classList.add('hidden');
                
                console.log('Raw response:', responseText); // Debug output
                
                try {
                    return JSON.parse(responseText);
                } catch (parseError) {
                    console.error('JSON Parse Error:', parseError);
                    console.error('Response text:', responseText);
                    return { success: false, error: 'Invalid JSON response from server' };
                }
            } catch (error) {
                document.getElementById('loading-indicator').classList.add('hidden');
                console.error('API Error:', error);
                return { success: false, error: error.message };
            }
        }

        // Enhanced login function with better error handling
        document.addEventListener('DOMContentLoaded', function() {
            // Setup the match type and cup round relationship
            const editMatchType = document.getElementById('edit-match-type');
            const editCupRound = document.getElementById('edit-cup-round');
            const editCupRoundContainer = document.getElementById('edit-cup-round-container');
            
            editMatchType.addEventListener('change', function() {
                if (this.value === 'cup') {
                    editCupRound.disabled = false;
                    editCupRoundContainer.classList.remove('disabled-field');
                } else {
                    editCupRound.disabled = true;
                    editCupRound.value = '';
                    editCupRoundContainer.classList.add('disabled-field');
                }
            });
            
            // Initial state setup
            if (editMatchType.value === 'league') {
                editCupRoundContainer.classList.add('disabled-field');
            }
            
            // Make sure the form exists before adding the event listener
            const loginForm = document.getElementById('edit-login-form-element');
            if (loginForm) {
                loginForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const username = document.getElementById('edit-username').value;
                    const password = document.getElementById('edit-password').value;
                    
                    console.log('Login attempt with:', { username });
                    console.log('Sending login request to:', `${API_URL}?endpoint=login`);
                    
                    try {
                        const result = await postApi('login', { username, password });
                        
                        console.log('Login response received:', result);
                        
                        if (result && result.success) {
                            // Store captain info globally for later use
                            currentCaptain = result.captain;
                            
                            // Get division for the team
                            await determineTeamDivision();
                            
                            // Display team information
                            const teamInfoDiv = document.getElementById('team-info');
                            teamInfoDiv.innerHTML = `
                                <p>Logged in as: <strong>${currentCaptain.team_name}</strong> captain</p>
                                <p>Division: <strong>${captainDivision.toUpperCase()}</strong></p>
                            `;
                            
                            document.getElementById('edit-login-form').classList.add('hidden');
                            document.getElementById('edit-scores-container').classList.remove('hidden');
                            
                            // Load matches for captain's division
                            loadEditMatchesSelect();
                        } else {
                            const errorMsg = result ? (result.error || 'Invalid credentials') : 'No response received';
                            alert('Login failed: ' + errorMsg);
                            console.error('Login error details:', result);
                        }
                    } catch (error) {
                        console.error('Login exception:', error);
                        alert('Login error: ' + error.message);
                    }
                });
            } else {
                console.error('Edit login form element not found!');
            }
        });

        // Determine the division of the captain's team
        async function determineTeamDivision() {
            if (!currentCaptain) {
                console.error('No captain information available');
                captainDivision = 'premier'; // Default fallback
                return;
            }
            
            try {
                // Call the teams endpoint without any division filter to get ALL teams
                const allTeams = await fetchApi('teams');
                console.log('All teams loaded for division check:', allTeams.length);
                
                // First try to find the team by team_id (most reliable method)
                if (currentCaptain.team_id) {
                    const teamById = allTeams.find(team => parseInt(team.team_id) === parseInt(currentCaptain.team_id));
                    if (teamById && teamById.division) {
                        captainDivision = teamById.division.toLowerCase();
                        console.log(`Captain's team division found by ID: ${captainDivision}`);
                        return;
                    }
                }
                
                // If team_id doesn't work, try by team name
                if (currentCaptain.team_name) {
                    const teamByName = allTeams.find(team => 
                        team.team_name.toLowerCase() === currentCaptain.team_name.toLowerCase()
                    );
                    if (teamByName && teamByName.division) {
                        captainDivision = teamByName.division.toLowerCase();
                        console.log(`Captain's team division found by name: ${captainDivision}`);
                        return;
                    }
                }
                
                // If we still don't have a division, use known A division team names
                const aDivisionTeams = [
                    'Ewhurst Arrows', 'Dingles', 'Johnson', 'Disappointers', 
                    'APV', 'Ewhurst Woodys', 'Pelham', 'Division A Bye'
                ];
                
                if (currentCaptain.team_name && 
                    aDivisionTeams.some(name => 
                        name.toLowerCase() === currentCaptain.team_name.toLowerCase()
                    )) {
                    captainDivision = 'a';
                    console.log("Team found in A division list");
                    return;
                }
                
                // Team IDs 9-16 are A division based on the schema
                if (currentCaptain.team_id && parseInt(currentCaptain.team_id) >= 9 && parseInt(currentCaptain.team_id) <= 16) {
                    captainDivision = 'a';
                    console.log("Team identified as A division by ID range");
                    return;
                }
                
                // Default to premier if all checks fail
                captainDivision = 'premier';
                console.warn(`Could not determine team division, defaulting to: ${captainDivision}`);
            } catch (error) {
                console.error('Error determining team division:', error);
                captainDivision = 'premier'; // Default to premier division
            }
        }

        // Edit Score functionality
        async function loadEditMatchesSelect() {
            const select = document.getElementById('match-select');
            
            // Clear existing options
            select.innerHTML = '<option value="">Select a match to edit...</option>';
            
            if (!currentCaptain) {
                console.error('No captain information available');
                return;
            }
            
            // Show loading state
            select.innerHTML = '<option value="">Loading matches...</option>';
            
            // Fetch both league and cup results for the captain's division
            const leagueResults = await fetchApi('league-results', { division: captainDivision });
            const cupResults = await fetchApi('cup-results', { division: captainDivision });
            
            // Filter results to only show matches where this captain's team was the home team
            const filteredLeagueResults = leagueResults.filter(match => 
                match.home_team === currentCaptain.team_name
            );
            
            const filteredCupResults = cupResults.filter(match => 
                match.home_team === currentCaptain.team_name
            );
            
            // Reset select
            select.innerHTML = '<option value="">Select a match to edit...</option>';
            
            // Add league matches
            if (filteredLeagueResults.length > 0) {
                const leagueGroup = document.createElement('optgroup');
                leagueGroup.label = 'League Matches';
                filteredLeagueResults.forEach(match => {
                    const option = document.createElement('option');
                    option.value = match.match_id;
                    option.dataset.matchType = 'league';
                    option.dataset.division = captainDivision;
                    option.dataset.homeTeam = match.home_team;
                    option.dataset.awayTeam = match.away_team;
                    option.textContent = `${match.home_team} vs ${match.away_team} (${match.match_date}) - ${match.home_score}-${match.away_score}`;
                    leagueGroup.appendChild(option);
                });
                select.appendChild(leagueGroup);
            }
            
            // Add cup matches
            if (filteredCupResults.length > 0) {
                const cupGroup = document.createElement('optgroup');
                cupGroup.label = 'Cup Matches';
                filteredCupResults.forEach(match => {
                    const option = document.createElement('option');
                    option.value = match.match_id;
                    option.dataset.matchType = 'cup';
                    option.dataset.division = captainDivision;
                    option.dataset.homeTeam = match.home_team;
                    option.dataset.awayTeam = match.away_team;
                    option.dataset.cupRound = match.cup_round || '';  // Store cup round info
                    option.textContent = `${match.home_team} vs ${match.away_team} (${match.match_date}) - ${match.home_score}-${match.away_score}${match.cup_round ? ' - ' + match.cup_round : ''}`;
                    cupGroup.appendChild(option);
                });
                select.appendChild(cupGroup);
            }
            
            // Display message if no matches to edit
            if (filteredLeagueResults.length === 0 && filteredCupResults.length === 0) {
                const noMatchesOption = document.createElement('option');
                noMatchesOption.disabled = true;
                noMatchesOption.textContent = `No ${captainDivision} division matches to edit for ${currentCaptain.team_name}`;
                select.appendChild(noMatchesOption);
            }
        }

        // Handle match selection for editing
        document.getElementById('match-select').addEventListener('change', async function() {
            const matchId = this.value;
            const matchFormContainer = document.getElementById('edit-match-form-container');
            
            if (!matchId) {
                matchFormContainer.classList.add('hidden');
                return;
            }
            
            // Show loading indicator
            const loadingIndicator = document.getElementById('loading-indicator');
            loadingIndicator.classList.remove('hidden');
            matchFormContainer.classList.remove('hidden');
            
            const selectedOption = this.options[this.selectedIndex];
            const matchType = selectedOption.dataset.matchType;
            const division = captainDivision; // Use the captain's division
            const homeTeam = selectedOption.dataset.homeTeam;
            const awayTeam = selectedOption.dataset.awayTeam;
            const cupRound = selectedOption.dataset.cupRound || '';
            
            // Set form values
            document.getElementById('edit-match-type').value = matchType;
            
            // Handle cup round field visibility
            const editCupRound = document.getElementById('edit-cup-round');
            const editCupRoundContainer = document.getElementById('edit-cup-round-container');
            
            if (matchType === 'cup') {
                editCupRound.disabled = false;
                editCupRound.value = cupRound;
                editCupRoundContainer.classList.remove('disabled-field');
            } else {
                editCupRound.disabled = true;
                editCupRound.value = '';
                editCupRoundContainer.classList.add('disabled-field');
            }
            
            // Load teams for the selects
            await loadEditTeamOptions();
            
            document.getElementById('edit-home-team').value = homeTeam;
            document.getElementById('edit-away-team').value = awayTeam;
            
            // Generate form fields
            generateEditDoublesMatches();
            generateEditSinglesMatches();
            generateEditOneEightiesInputs();
            generateEditHighFinishesInputs();
            
            // Load existing match data with the new match-details endpoint
            await loadExistingMatchData(matchId);
            
            // Hide loading indicator
            loadingIndicator.classList.add('hidden');
        });

        async function loadEditTeamOptions() {
            const teams = await fetchApi('teams', { division: captainDivision });
            
            const homeSelect = document.getElementById('edit-home-team');
            const awaySelect = document.getElementById('edit-away-team');
            
            homeSelect.innerHTML = '';
            awaySelect.innerHTML = '';
            
            teams.forEach(team => {
                homeSelect.add(new Option(team.team_name, team.team_name));
                awaySelect.add(new Option(team.team_name, team.team_name));
            });
        }

        /**
         * Gets players selected for doubles games only
         * @returns {Object} Object with home and away player sets
         */
        function getSelectedDoublesPlayers() {
            const selectedPlayers = {
                home: new Set(),
                away: new Set()
            };
            
            // Get all selected home players from doubles only
            document.querySelectorAll('.home-player1, .home-player2').forEach(select => {
                if (select.value) {
                    selectedPlayers.home.add(select.value);
                }
            });
            
            // Get all selected away players from doubles only
            document.querySelectorAll('.away-player1, .away-player2').forEach(select => {
                if (select.value) {
                    selectedPlayers.away.add(select.value);
                }
            });
            
            return selectedPlayers;
        }

        /**
         * Gets players selected for singles games only
         * @returns {Object} Object with home and away player sets
         */
        function getSelectedSinglesPlayers() {
            const selectedPlayers = {
                home: new Set(),
                away: new Set()
            };
            
            // Get all selected home players from singles only
            document.querySelectorAll('.home-player').forEach(select => {
                if (select.value) {
                    selectedPlayers.home.add(select.value);
                }
            });
            
            // Get all selected away players from singles only
            document.querySelectorAll('.away-player').forEach(select => {
                if (select.value) {
                    selectedPlayers.away.add(select.value);
                }
            });
            
            return selectedPlayers;
        }

        async function updateEditPlayerSelects(side) {
            const teamName = document.getElementById(`edit-${side}-team`).value;
            if (!teamName) {
                // Clear player selects if no team is selected
                document.querySelectorAll(`.${side}-player, .${side}-player1, .${side}-player2`).forEach(select => {
                    select.innerHTML = '<option value="">Select Player</option>';
                });
                return;
            }
            
            // Update both singles and doubles player options
            await updateAllPlayerSelects();
        }

        /**
         * Updates player options for both singles and doubles matches
         */
        async function updateAllPlayerSelects() {
            await updateDoublesPlayerOptions();
            await updateSinglesPlayerOptions();
        }

        /**
         * Updates player options for doubles matches to exclude already selected players in doubles only
         */
        async function updateDoublesPlayerOptions() {
            const homeTeamName = document.getElementById('edit-home-team').value;
            const awayTeamName = document.getElementById('edit-away-team').value;
            
            if (!homeTeamName && !awayTeamName) return;
            
            // Get players selected in doubles matches only
            const selectedPlayers = getSelectedDoublesPlayers();
            
            if (homeTeamName) {
                const homePlayers = await fetchApi('players', { team_name: homeTeamName });
                
                document.querySelectorAll('.home-player1, .home-player2').forEach(select => {
                    const currentValue = select.value;
                    const currentSelectionExcludingThisOne = new Set(selectedPlayers.home);
                    
                    // Remove this element's selection from the list of excluded players
                    if (currentValue) {
                        currentSelectionExcludingThisOne.delete(currentValue);
                    }
                    
                    select.innerHTML = '<option value="">Select Player</option>';
                    
                    homePlayers.forEach(player => {
                        // Only add player if they're not already selected in another doubles match
                        // or if they're the currently selected player in this dropdown
                        if (!currentSelectionExcludingThisOne.has(player.player_name)) {
                            select.add(new Option(player.player_name, player.player_name));
                        }
                    });
                    
                    // Restore current value if still valid
                    if (currentValue && homePlayers.some(p => p.player_name === currentValue)) {
                        select.value = currentValue;
                    }
                });
            }
            
            if (awayTeamName) {
                const awayPlayers = await fetchApi('players', { team_name: awayTeamName });
                
                document.querySelectorAll('.away-player1, .away-player2').forEach(select => {
                    const currentValue = select.value;
                    const currentSelectionExcludingThisOne = new Set(selectedPlayers.away);
                    
                    // Remove this element's selection from the list of excluded players
                    if (currentValue) {
                        currentSelectionExcludingThisOne.delete(currentValue);
                    }
                    
                    select.innerHTML = '<option value="">Select Player</option>';
                    
                    awayPlayers.forEach(player => {
                        // Only add player if they're not already selected in another doubles match
                        // or if they're the currently selected player in this dropdown
                        if (!currentSelectionExcludingThisOne.has(player.player_name)) {
                            select.add(new Option(player.player_name, player.player_name));
                        }
                    });
                    
                    // Restore current value if still valid
                    if (currentValue && awayPlayers.some(p => p.player_name === currentValue)) {
                        select.value = currentValue;
                    }
                });
            }
        }

        /**
         * Updates player options for singles matches to exclude already selected players in singles only
         */
        async function updateSinglesPlayerOptions() {
            const homeTeamName = document.getElementById('edit-home-team').value;
            const awayTeamName = document.getElementById('edit-away-team').value;
            
            if (!homeTeamName && !awayTeamName) return;
            
            // Get players selected in singles matches only
            const selectedPlayers = getSelectedSinglesPlayers();
            
            if (homeTeamName) {
                const homePlayers = await fetchApi('players', { team_name: homeTeamName });
                
                document.querySelectorAll('.home-player').forEach(select => {
                    const currentValue = select.value;
                    const currentSelectionExcludingThisOne = new Set(selectedPlayers.home);
                    
                    // Remove this element's selection from the list of excluded players
                    if (currentValue) {
                        currentSelectionExcludingThisOne.delete(currentValue);
                    }
                    
                    select.innerHTML = '<option value="">Select Home Player</option>';
                    
                    homePlayers.forEach(player => {
                        // Only add player if they're not already selected in another singles match
                        // or if they're the currently selected player in this dropdown
                        if (!currentSelectionExcludingThisOne.has(player.player_name)) {
                            select.add(new Option(player.player_name, player.player_name));
                        }
                    });
                    
                    // Restore current value if still valid
                    if (currentValue && homePlayers.some(p => p.player_name === currentValue)) {
                        select.value = currentValue;
                    }
                });
            }
            
            if (awayTeamName) {
                const awayPlayers = await fetchApi('players', { team_name: awayTeamName });
                
                document.querySelectorAll('.away-player').forEach(select => {
                    const currentValue = select.value;
                    const currentSelectionExcludingThisOne = new Set(selectedPlayers.away);
                    
                    // Remove this element's selection from the list of excluded players
                    if (currentValue) {
                        currentSelectionExcludingThisOne.delete(currentValue);
                    }
                    
                    select.innerHTML = '<option value="">Select Away Player</option>';
                    
                    awayPlayers.forEach(player => {
                        // Only add player if they're not already selected in another singles match
                        // or if they're the currently selected player in this dropdown
                        if (!currentSelectionExcludingThisOne.has(player.player_name)) {
                            select.add(new Option(player.player_name, player.player_name));
                        }
                    });
                    
                    // Restore current value if still valid
                    if (currentValue && awayPlayers.some(p => p.player_name === currentValue)) {
                        select.value = currentValue;
                    }
                });
            }
        }

        // Modify how the match data is loaded to ensure proper player selection syncing
        async function loadExistingMatchData(matchId) {
            // Fetch match details using the match-details endpoint
            const matchData = await fetchApi('match-details', { match_id: matchId });
            
            if (!matchData || !matchData.success) {
                console.error('Failed to load match data:', matchData);
                alert('Failed to load match details. Please try again.');
                return;
            }
            
            console.log('Loaded match data:', matchData);
            
            // Set cup round if it's a cup match
            if (matchData.match && matchData.match.match_type === 'cup') {
                document.getElementById('edit-cup-round').value = matchData.match.cup_round || '';
                document.getElementById('edit-cup-round').disabled = false;
                document.getElementById('edit-cup-round-container').classList.remove('disabled-field');
            } else {
                document.getElementById('edit-cup-round').disabled = true;
                document.getElementById('edit-cup-round-container').classList.add('disabled-field');
            }
            
            // Load players for both teams
            const homeTeam = document.getElementById('edit-home-team').value;
            const awayTeam = document.getElementById('edit-away-team').value;
            
            // Update player selects
            await updateEditPlayerSelects('home');
            await updateEditPlayerSelects('away');
            
            // Populate existing data - do doubles first
            if (matchData.doubles && matchData.doubles.length > 0) {
                const doublesContainers = document.querySelectorAll('#edit-doubles-matches .doubles-match');
                
                // First, set up the structure
                for (let i = 0; i < matchData.doubles.length; i++) {
                    if (i < doublesContainers.length) {
                        const doubles = matchData.doubles[i];
                        const container = doublesContainers[i];
                        
                        // Set values one by one and trigger change events to update player options properly
                        const homePlayer1Select = container.querySelector('.home-player1');
                        homePlayer1Select.value = doubles.home_player1_name;
                        homePlayer1Select.dispatchEvent(new Event('change'));
                        
                        const homePlayer2Select = container.querySelector('.home-player2');
                        homePlayer2Select.value = doubles.home_player2_name;
                        homePlayer2Select.dispatchEvent(new Event('change'));
                        
                        const awayPlayer1Select = container.querySelector('.away-player1');
                        awayPlayer1Select.value = doubles.away_player1_name;
                        awayPlayer1Select.dispatchEvent(new Event('change'));
                        
                        const awayPlayer2Select = container.querySelector('.away-player2');
                        awayPlayer2Select.value = doubles.away_player2_name;
                        awayPlayer2Select.dispatchEvent(new Event('change'));
                        
                        container.querySelector('.score-select').value = `${doubles.home_score}-${doubles.away_score}`;
                    }
                }
            }
            
            // Then do singles matches after doubles
            if (matchData.singles && matchData.singles.length > 0) {
                const singlesContainers = document.querySelectorAll('#edit-singles-matches .singles-match');
                
                for (let i = 0; i < matchData.singles.length; i++) {
                    if (i < singlesContainers.length) {
                        const singles = matchData.singles[i];
                        const container = singlesContainers[i];
                        
                        // Set values one by one and trigger change events to update player options properly
                        const homePlayerSelect = container.querySelector('.home-player');
                        homePlayerSelect.value = singles.home_player_name;
                        homePlayerSelect.dispatchEvent(new Event('change'));
                        
                        const awayPlayerSelect = container.querySelector('.away-player');
                        awayPlayerSelect.value = singles.away_player_name;
                        awayPlayerSelect.dispatchEvent(new Event('change'));
                        
                        container.querySelector('.score-select').value = `${singles.home_score}-${singles.away_score}`;
                    }
                }
            }
            
            // Populate 180s
            if (matchData.oneEighties && matchData.oneEighties.length > 0) {
                const container = document.getElementById('edit-one-eighties-section');
                // Clear existing rows except the add button
                container.querySelectorAll('.stats-row').forEach(row => row.remove());
                
                matchData.oneEighties.forEach((oneEighty, index) => {
                    addEditOneEightyInputRow();
                    const rows = container.querySelectorAll('.stats-row');
                    if (index < rows.length) {
                        const row = rows[index];
                        row.querySelector('.one-eighty-player').value = oneEighty.player_name;
                        row.querySelector('.one-eighty-count').value = oneEighty.count;
                    }
                });
            }
            
            // Populate high finishes
            if (matchData.highFinishes && matchData.highFinishes.length > 0) {
                const container = document.getElementById('edit-high-finishes-section');
                // Clear existing rows except the add button
                container.querySelectorAll('.stats-row').forEach(row => row.remove());
               
                matchData.highFinishes.forEach((highFinish, index) => {
                    addEditHighFinishInputRow();
                    const rows = container.querySelectorAll('.stats-row');
                    if (index < rows.length) {
                        const row = rows[index];
                        row.querySelector('.high-finish-player').value = highFinish.player_name;
                        row.querySelector('.high-finish-value').value = highFinish.finish_value;
                    }
                });
            }
        }

        // Generate doubles matches with captain's division
        function generateEditDoublesMatches() {
            const doublesMatchesDiv = document.getElementById('edit-doubles-matches');
            doublesMatchesDiv.innerHTML = '';
            
            for (let i = 1; i <= 3; i++) {
                const matchDiv = document.createElement('div');
                matchDiv.className = 'doubles-match';
                
                let scoreOptions = '';
                if (captainDivision === 'premier') {
                    scoreOptions = `
                        <option value="3-0">3-0 (Home Win)</option>
                        <option value="3-1">3-1 (Home Win)</option>
                        <option value="3-2">3-2 (Home Win)</option>
                        <option value="2-3">2-3 (Away Win)</option>
                        <option value="1-3">1-3 (Away Win)</option>
                        <option value="0-3">0-3 (Away Win)</option>
                    `;
                } else {
                    scoreOptions = `
                        <option value="2-0">2-0 (Home Win)</option>
                        <option value="2-1">2-1 (Home Win)</option>
                        <option value="1-2">1-2 (Away Win)</option>
                        <option value="0-2">0-2 (Away Win)</option>
                    `;
                }
                
                matchDiv.innerHTML = `
                    <div class="match-header">Doubles Game ${i}</div>
                    <div class="doubles-players">
                        <div class="home-side">
                            <select class="player-select home-player1" data-match="${i}">
                                <option value="">Select Home Player 1</option>
                            </select>
                            <select class="player-select home-player2" data-match="${i}">
                                <option value="">Select Home Player 2</option>
                            </select>
                        </div>
                        <select class="score-select" data-match="${i}">
                            ${scoreOptions}
                        </select>
                        <div class="away-side">
                            <select class="player-select away-player1" data-match="${i}">
                                <option value="">Select Away Player 1</option>
                            </select>
                            <select class="player-select away-player2" data-match="${i}">
                                <option value="">Select Away Player 2</option>
                            </select>
                        </div>
                    </div>
                `;
                doublesMatchesDiv.appendChild(matchDiv);
                
                // Add change event listeners to all doubles player selects
                matchDiv.querySelectorAll('.home-player1, .home-player2, .away-player1, .away-player2').forEach(select => {
                    select.addEventListener('change', updateDoublesPlayerOptions);
                });
            }
        }

        // Generate singles matches with captain's division
        function generateEditSinglesMatches() {
            const singlesMatchesDiv = document.getElementById('edit-singles-matches');
            singlesMatchesDiv.innerHTML = '';
            
            for (let i = 1; i <= 6; i++) {
                const matchDiv = document.createElement('div');
                matchDiv.className = 'singles-match';
                
                let scoreOptions = '';
                if (captainDivision === 'premier') {
                    scoreOptions = `
                        <option value="3-0">3-0 (Home Win)</option>
                        <option value="3-1">3-1 (Home Win)</option>
                        <option value="3-2">3-2 (Home Win)</option>
                        <option value="2-3">2-3 (Away Win)</option>
                        <option value="1-3">1-3 (Away Win)</option>
                        <option value="0-3">0-3 (Away Win)</option>
                    `;
                } else {
                    scoreOptions = `
                        <option value="2-0">2-0 (Home Win)</option>
                        <option value="2-1">2-1 (Home Win)</option>
                        <option value="1-2">1-2 (Away Win)</option>
                        <option value="0-2">0-2 (Away Win)</option>
                    `;
                }
                
                matchDiv.innerHTML = `
                    <div class="match-header">Singles Game ${i}</div>
                    <div class="singles-players">
                        <div class="home-side">
                            <select class="player-select home-player" data-match="${i}">
                                <option value="">Select Home Player</option>
                            </select>
                        </div>
                        <select class="score-select" data-match="${i}">
                            ${scoreOptions}
                        </select>
                        <div class="away-side">
                            <select class="player-select away-player" data-match="${i}">
                                <option value="">Select Away Player</option>
                            </select>
                        </div>
                    </div>
                `;
                singlesMatchesDiv.appendChild(matchDiv);
                
                // Add change event listeners to all singles player selects
                matchDiv.querySelectorAll('.home-player, .away-player').forEach(select => {
                    select.addEventListener('change', updateSinglesPlayerOptions);
                });
            }
        }

        function generateEditOneEightiesInputs() {
            const container = document.getElementById('edit-one-eighties-section');
            container.innerHTML = '';
            
            // Add initial input row
            addEditOneEightyInputRow();
            
            // Add button to add more rows
            const addButton = document.createElement('button');
            addButton.type = 'button';
            addButton.className = 'add-stat-btn';
            addButton.textContent = 'Add Another 180';
            addButton.addEventListener('click', addEditOneEightyInputRow);
            container.appendChild(addButton);
        }

        function addEditOneEightyInputRow() {
            const container = document.getElementById('edit-one-eighties-section');
            const rowCount = container.querySelectorAll('.stats-row').length;
            
            const row = document.createElement('div');
            row.className = 'stats-row';
            row.innerHTML = `
                <select class="player-select one-eighty-player" data-row="${rowCount + 1}">
                    <option value="">Select Player</option>
                </select>
                <input type="number" class="one-eighty-count" value="1" min="1" placeholder="Number of 180s">
                ${rowCount > 0 ? '<button type="button" class="remove-stat-btn">Remove</button>' : ''}
            `;
            
            // Add before the add button
            const addButton = container.querySelector('.add-stat-btn');
            container.insertBefore(row, addButton);
            
            // Add remove functionality
            const removeBtn = row.querySelector('.remove-stat-btn');
            if (removeBtn) {
                removeBtn.addEventListener('click', () => row.remove());
            }
            
            // Populate player options
            populateEditStatPlayerOptions(row.querySelector('.one-eighty-player'));
        }

        function generateEditHighFinishesInputs() {
            const container = document.getElementById('edit-high-finishes-section');
            container.innerHTML = '';
            
            // Add initial input row
            addEditHighFinishInputRow();
            
            // Add button to add more rows
            const addButton = document.createElement('button');
            addButton.type = 'button';
            addButton.className = 'add-stat-btn';
            addButton.textContent = 'Add Another High Finish';
            addButton.addEventListener('click', addEditHighFinishInputRow);
            container.appendChild(addButton);
        }

        function addEditHighFinishInputRow() {
            const container = document.getElementById('edit-high-finishes-section');
            const rowCount = container.querySelectorAll('.stats-row').length;
            
            const row = document.createElement('div');
            row.className = 'stats-row';
            row.innerHTML = `
                <select class="player-select high-finish-player" data-row="${rowCount + 1}">
                    <option value="">Select Player</option>
                </select>
                <input type="number" class="high-finish-value" min="100" placeholder="Finish value">
                ${rowCount > 0 ? '<button type="button" class="remove-stat-btn">Remove</button>' : ''}
            `;
            
            // Add before the add button
            const addButton = container.querySelector('.add-stat-btn');
            container.insertBefore(row, addButton);
            
            // Add remove functionality
            const removeBtn = row.querySelector('.remove-stat-btn');
            if (removeBtn) {
                removeBtn.addEventListener('click', () => row.remove());
            }
            
            // Populate player options
            populateEditStatPlayerOptions(row.querySelector('.high-finish-player'));
        }

        async function populateEditStatPlayerOptions(select) {
            const homeTeam = document.getElementById('edit-home-team').value;
            const awayTeam = document.getElementById('edit-away-team').value;
            
            if (homeTeam) {
                const homePlayers = await fetchApi('players', { team_name: homeTeam });
                homePlayers.forEach(player => {
                    select.add(new Option(`${player.player_name} (${homeTeam})`, player.player_name));
                });
            }
            
            if (awayTeam) {
                const awayPlayers = await fetchApi('players', { team_name: awayTeam });
                awayPlayers.forEach(player => {
                    select.add(new Option(`${player.player_name} (${awayTeam})`, player.player_name));
                });
            }
        }

        // Edit match form submission
        document.getElementById('edit-match-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const matchId = document.getElementById('match-select').value;
            if (!matchId) {
                alert('Please select a match to edit');
                return;
            }
            
            const matchType = document.getElementById('edit-match-type').value;
            
            const matchData = {
                matchId: matchId,
                division: captainDivision,
                matchType: matchType,
                homeTeam: document.getElementById('edit-home-team').value,
                awayTeam: document.getElementById('edit-away-team').value,
                doubles: [],
                singles: [],
                oneEighties: [],
                highFinishes: []
            };
            
            // Add cup round if it's a cup match
            if (matchType === 'cup') {
                const cupRound = document.getElementById('edit-cup-round').value;
                if (!cupRound) {
                    alert('Please select a Cup Round for cup matches.');
                    return;
                }
                matchData.cupRound = cupRound;
            }
            
            // Collect doubles match data
            document.querySelectorAll('#edit-doubles-matches .doubles-match').forEach((match, index) => {
                const homePlayer1 = match.querySelector('.home-player1').value;
                const homePlayer2 = match.querySelector('.home-player2').value;
                const awayPlayer1 = match.querySelector('.away-player1').value;
                const awayPlayer2 = match.querySelector('.away-player2').value;
                const score = match.querySelector('.score-select').value;
                
                if (homePlayer1 && homePlayer2 && awayPlayer1 && awayPlayer2 && score) {
                    matchData.doubles.push({
                        homePlayer1,
                        homePlayer2,
                        awayPlayer1,
                        awayPlayer2,
                        score
                    });
                }
            });

            // Collect singles match data
            document.querySelectorAll('#edit-singles-matches .singles-match').forEach((match, index) => {
                const homePlayer = match.querySelector('.home-player').value;
                const awayPlayer = match.querySelector('.away-player').value;
                const score = match.querySelector('.score-select').value;
                
                if (homePlayer && awayPlayer && score) {
                    matchData.singles.push({
                        homePlayer,
                        awayPlayer,
                        score
                    });
                }
            });
            
            // Collect 180s data
            document.querySelectorAll('#edit-one-eighties-section .stats-row').forEach(row => {
                const player = row.querySelector('.one-eighty-player').value;
                const count = row.querySelector('.one-eighty-count').value;
                
                if (player && count) {
                    matchData.oneEighties.push({
                        player,
                        count: parseInt(count)
                    });
                }
            });
            
            // Collect high finishes data
            document.querySelectorAll('#edit-high-finishes-section .stats-row').forEach(row => {
                const player = row.querySelector('.high-finish-player').value;
                const value = row.querySelector('.high-finish-value').value;
                
                if (player && value) {
                    matchData.highFinishes.push({
                        player,
                        value: parseInt(value)
                    });
                }
            });
            
            // Validate that at least one game is complete
            if (matchData.doubles.length === 0 && matchData.singles.length === 0) {
                alert('Please enter scores for at least one game.');
                return;
            }
            
            console.log('Updating match data:', matchData); // Debug output

            // Show loading indicator while submitting
            const loadingIndicator = document.getElementById('loading-indicator');
            loadingIndicator.textContent = 'Updating match...';
            loadingIndicator.classList.remove('hidden');
            
            const result = await postApi('update-match', matchData);
            
            // Hide loading indicator
            loadingIndicator.classList.add('hidden');
            
            if (result.success) {
                alert('Match score updated successfully!');
                document.getElementById('match-select').value = '';
                document.getElementById('edit-match-form-container').classList.add('hidden');
                // Reload the matches list
                loadEditMatchesSelect();
            } else {
                alert('Error updating match: ' + (result.error || 'Unknown error'));
                console.error('Error details:', result);
            }
        });
    </script>
</body>
</html>