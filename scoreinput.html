<!DOCTYPE html>
<html lang="en">
    <link rel="icon" href="cdl.png">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Submit match scores for the Crawley Darts League. Team captains can log in to record match results, 180s, and high finishes.">
<meta property="og:title" content="CDL | Score Input">
<meta property="og:description" content="Submit match scores for the Crawley Darts League. Team captains can log in to record match results, 180s, and high finishes.">
<meta property="og:image" content="https://crawleydartsleague.com/cdl-logo.png">
    <title>CDL | Score Input</title>
    <link rel="stylesheet" href="styles.css">
<style>
        /* Cup round dropdown styling when disabled */
        #cup-round-container.disabled-field {
            opacity: 0.6;
            pointer-events: none;
        }
        
        #cup-round-container {
            transition: opacity 0.3s ease;
        }
        
        /* Team info display */
        .team-info {
            background-color: #e8f5e9;
            padding: 10px 15px;
            margin-bottom: 20px;
            border-radius: 5px;
            border-left: 4px solid var(--success);
            font-size: 0.95em;
        }
        
        .team-info p {
            margin: 5px 0;
        }
        
        /* Disabled home team and division selectors */
        #home-team:disabled, #division:disabled {
            background-color: #f5f5f5;
            cursor: not-allowed;
        }
                /* Custom header style for the index page to position logo left and title centered */
                .header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .logo-container {
            position: absolute;
            right: 20px;
            top: 55%;
            transform: translateY(-50%);
        }
        
        .logo {
            width: 60px;
            height: 58px;
            object-fit: contain;
        }
        
        .header h1 {
            margin: 0;
            text-align: center;
        }
        /* Basic dropdown styling */
.nav .dropdown {
    position: relative;
}

.nav .dropdown-toggle {
    cursor: pointer;
}

.nav .dropdown-menu {
    display: none;
    position: absolute;
    background: white;
    min-width: 200px;
    box-shadow: 0 8px 16px rgba(0,0,0,0.1);
    z-index: 1000;
    border-radius: 4px;
    padding: 10px 0;
}

.nav .dropdown:hover .dropdown-menu {
    display: block;
}

.nav .dropdown-menu li {
    margin: 0;
    padding: 0;
}

.nav .dropdown-menu a {
    display: block;
    padding: 10px 20px;
    color: var(--primary);
    border-radius: 0;
}

.nav .dropdown-menu a:hover {
    background-color: var(--light-gray);
}

/* Mobile navigation */
.mobile-nav-toggle {
    display: none;
    cursor: pointer;
    padding: 10px;
    font-size: 1.5rem;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .mobile-nav-toggle {
        display: block;
    }
    
    .nav-menu {
        display: none;
        position: absolute;
        top: 100%;
        left: 0;
        width: 100%;
        background: white;
        box-shadow: 0 5px 10px rgba(0,0,0,0.1);
        z-index: 1000;
        padding: 0;
        margin: 0;
    }
    
    .nav-menu.active {
        display: block;
    }
    
    .nav-menu li {
        margin: 0;
        padding: 0;
        display: block;
        border-bottom: 1px solid var(--light-gray);
    }
    
    .nav-menu a {
        padding: 15px 20px;
        display: block;
    }
    
    .nav .dropdown-menu {
        position: static;
        box-shadow: none;
        background: var(--light-gray);
        width: 100%;
        padding: 0;
    }
    
    .nav .dropdown-menu li:first-child {
        border-top: 1px solid var(--medium-gray);
    }
    
    .nav .dropdown:hover .dropdown-menu {
        display: none; /* Don't show on hover on mobile */
    }
    
    /* Add a + icon to dropdowns */
    .nav .dropdown-toggle::after {
        content: "+";
        margin-left: 5px;
    }
    
    /* Toggle this class with JavaScript */
    .nav .dropdown.active .dropdown-menu {
        display: block;
    }
    
    .nav .dropdown.active .dropdown-toggle::after {
        content: "-";
    }
}
:root {
    --primary: #1a237e;
    --secondary: #3949ab;
    --light-gray: #f5f5f5;
    --medium-gray: #e0e0e0;
    --dark-gray: #757575;
    --card-bg: #ffffff;
}

/* Header Styles */
.header {
    background: linear-gradient(135deg, var(--primary), var(--secondary));
    color: white;
    padding: 15px 20px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    display: flex;
    justify-content: center;
    align-items: center;
    position: relative;
}



.header h1 {
    margin: 0;
    text-align: center;
    font-size: 1.5rem;
}

/* Navigation Styles */
.nav {
    background-color: white;
    position: relative;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.nav-menu {
    list-style: none;
    padding: 0;
    margin: 0;
    display: flex;
    justify-content: center;
}

.nav-menu > li {
    position: relative;
    margin: 0;
}

.nav-menu > li > a {
    display: block;
    padding: 15px;
    color: var(--primary);
    text-decoration: none;
    font-weight: 500;
    transition: all 0.3s ease;
}

.nav-menu > li > a:hover {
    background-color: var(--light-gray);
}

/* Dropdown Menu */
.dropdown {
    position: relative;
}

.dropdown-toggle:after {
    content: "▼";
    font-size: 0.7em;
    margin-left: 5px;
    vertical-align: middle;
}

.dropdown-menu {
    position: absolute;
    top: 100%;
    left: 0;
    background-color: white;
    min-width: 200px;
    padding: 5px 0;
    margin: 0;
    list-style: none;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    border-radius: 0 0 4px 4px;
    z-index: 100;
    opacity: 0;
    visibility: hidden;
    transform: translateY(10px);
    transition: all 0.3s ease;
}

.dropdown:hover .dropdown-menu,
.dropdown:focus-within .dropdown-menu,
.dropdown-menu:hover {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
}

.dropdown-menu li {
    margin: 0;
}

.dropdown-menu a {
    display: block;
    padding: 10px 15px;
    color: var(--primary);
    text-decoration: none;
    transition: all 0.3s ease;
}

.dropdown-menu a:hover {
    background-color: var(--light-gray);
}

/* Mobile Toggle Button */
.mobile-toggle {
    display: none;
    background: transparent;
    border: none;
    cursor: pointer;
    padding: 10px;
    position: absolute;
    left: 20px;
    top: 50%;
    transform: translateY(-50%);
    z-index: 10;
}

.mobile-toggle .bar {
    display: block;
    width: 25px;
    height: 3px;
    margin: 5px auto;
    background-color: white;
    transition: all 0.3s ease;
}

/* Media Queries for Responsive Design */
@media screen and (max-width: 992px) {
    .nav-menu {
        justify-content: flex-start;
    }
    
    .nav-menu > li > a {
        padding: 15px 10px;
        font-size: 0.9rem;
    }
}

@media screen and (max-width: 768px) {
    .header h1 {
        font-size: 1.3rem;
    }
    
    .mobile-toggle {
        display: block;
    }
    
    .nav-menu {
        flex-direction: column;
        position: absolute;
        top: 100%;
        left: 0;
        width: 100%;
        background-color: white;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.5s ease;
        z-index: 100;
    }
    
    .nav-menu.active {
        max-height: 1000px;
    }
    
    .dropdown-menu {
        position: static;
        box-shadow: none;
        opacity: 1;
        visibility: visible;
        transform: none;
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease;
    }
    
    .dropdown.active .dropdown-menu {
        max-height: 500px;
    }
    
    .dropdown-toggle:after {
        float: right;
    }
    
    .dropdown.active .dropdown-toggle:after {
        content: "▲";
    }
    
    .nav-menu > li {
        border-bottom: 1px solid var(--light-gray);
    }
    
    .dropdown-menu li {
        background-color: var(--light-gray);
        padding-left: 15px;
    }
}

@media screen and (max-width: 480px) {
    .header h1 {
        font-size: 1.1rem;
    }
    
    .logo {
        width: 50px;
        height: 48px;
    }
}
</style>
</head>
<body>
<header class="header">
    <div class="logo-container">
        <img src="cdl-logo.png" alt="Crawley Darts League Logo" class="logo">
    </div>
    <h1>Crawley Darts League</h1>
    <button class="mobile-toggle" aria-label="Toggle menu">
        <span class="bar"></span>
        <span class="bar"></span>
        <span class="bar"></span>
    </button>
</header>

<nav class="nav">
    <ul class="nav-menu">
        <li><a href="index.html">Home</a></li>
        
        <li class="dropdown">
            <a href="#" class="dropdown-toggle">League</a>
            <ul class="dropdown-menu">
                <li><a href="leaguetable.html">League Table</a></li>
                <li><a href="leaguefixtures.html">Fixtures</a></li>
                <li><a href="leagueresults.html">Results</a></li>
            </ul>
        </li>
        
        <li class="dropdown">
            <a href="#" class="dropdown-toggle">Competitions</a>
            <ul class="dropdown-menu">
                <li><a href="knockoutcup.html">Knockout Cup</a></li>
                <li><a href="singlescup.html">Singles Cup</a></li>
                <li><a href="pairscup.html">Pairs Cup</a></li>
                <li><a href="treblescup.html">Trebles Cup</a></li>
                <li><a href="captainscup.html">Captains Cup</a></li>
                <li><a href="cupdraw.html">Auto Draw Tool</a></li>
            </ul>
        </li>
        
        <li class="dropdown">
            <a href="#" class="dropdown-toggle">Statistics</a>
            <ul class="dropdown-menu">
                <li><a href="180sfinishes.html">180s & High Finishes</a></li>
                <li><a href="playerrankings.html">Player Rankings</a></li>
            </ul>
        </li>
        
        <li class="dropdown">
            <a href="#" class="dropdown-toggle">Information</a>
            <ul class="dropdown-menu">
                <li><a href="contactinfo.html">Contacts & Venues</a></li>
                <li><a href="rules.html">League Rules</a></li>
                <li><a href="agm-minutes.html">AGM Minutes</a></li>
                <li><a href="players.html">Players</a></li>
            </ul>
        </li>
        
        <li class="dropdown">
            <a href="#" class="dropdown-toggle">Submit Score</a>
            <ul class="dropdown-menu">
                <li><a href="scoreinput.html">Submit Score</a></li>
                <li><a href="editscores.html">Edit Score</a></li>
            </ul>
        </li>

            <li class="dropdown">
                <a href="#" class="dropdown-toggle">Join</a>
                <ul class="dropdown-menu">
                    <li><a href="registration.html">Registration Form</a></li>
                    <li><a href="findateam.html">Find a Team</a></li>
                </ul>
        </li>
    </ul>
    </nav>    <div class="container">
        <!-- Submit Score Page -->
        <div id="score-input" class="page">
            <div id="loading-indicator" class="hidden">Processing...</div>

            <div id="login-form" class="card login-form">
                <h2>Submit Score Login</h2>
                <form id="login-form-element">
                    <div class="form-group">
                        <label for="username">Username</label>
                        <input type="text" id="username" required>
                    </div>
                    <div class="form-group">
                        <label for="password">Password</label>
                        <input type="password" id="password" required>
                    </div>
                    <button type="submit" class="btn">Login</button>
                </form>
            </div>

            <div id="score-input-form" class="card score-input-container hidden">
                <h2>Match Submit Score</h2>
                
                <div id="team-info" class="team-info">
                    <!-- Team info will be displayed here after login -->
                </div>
                
                <form id="match-form">
                    <div class="form-group">
                        <label for="division">Division</label>
                        <select id="division" disabled>
                            <option value="premier">Premier Division</option>
                            <option value="a">A Division</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="match-type">Match Type</label>
                        <select id="match-type">
                            <option value="league">League</option>
                            <option value="cup">Cup</option>
                        </select>
                    </div>
                    <div class="form-group" id="cup-round-container">
                        <label for="cup-round">Cup Round</label>
                        <select id="cup-round" disabled>
                            <option value="">Select Cup Round</option>
                            <option value="Last 16">Last 16</option>
                            <option value="Quarter Final">Quarter Final</option>
                            <option value="Semi Final">Semi Final</option>
                            <option value="Final">Final</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="home-team">Home Team (Your Team)</label>
                        <select id="home-team" disabled>
                            <!-- This will be auto-populated with logged-in team -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="away-team">Away Team</label>
                        <select id="away-team">
                            <!-- Team options will be loaded dynamically -->
                        </select>
                    </div>
                    
                    <h3>Doubles Matches (3 games)</h3>
                    <div id="doubles-matches">
                        <!-- Doubles match inputs will be generated dynamically -->
                    </div>
                    
                    <h3>Singles Matches (6 games)</h3>
                    <div id="singles-matches">
                        <!-- Singles match inputs will be generated dynamically -->
                    </div>
                    
                    <h3>180s</h3>
                    <div id="one-eighties-section" class="stats-section">
                        <!-- 180s inputs will be generated dynamically -->
                    </div>
                    
                    <h3>High Finishes</h3>
                    <div id="high-finishes-section" class="stats-section">
                        <!-- High finishes inputs will be generated dynamically -->
                    </div>
                    
                    <button type="submit" class="btn">Submit Score</button>
                </form>
            </div>
        </div>
    </div>

    <script>
document.addEventListener('DOMContentLoaded', function() {
    const mobileToggle = document.querySelector('.mobile-toggle');
    const navMenu = document.querySelector('.nav-menu');
    const dropdownToggles = document.querySelectorAll('.dropdown-toggle');
    
    // Toggle mobile menu
    mobileToggle.addEventListener('click', function() {
        navMenu.classList.toggle('active');
        
        // Animate hamburger to X
        this.classList.toggle('active');
        const bars = this.querySelectorAll('.bar');
        if (this.classList.contains('active')) {
            bars[0].style.transform = 'rotate(-45deg) translate(-5px, 6px)';
            bars[1].style.opacity = '0';
            bars[2].style.transform = 'rotate(45deg) translate(-5px, -6px)';
        } else {
            bars[0].style.transform = 'none';
            bars[1].style.opacity = '1';
            bars[2].style.transform = 'none';
        }
    });
    
    // Handle dropdown menus on mobile
    dropdownToggles.forEach(toggle => {
        toggle.addEventListener('click', function(e) {
            // Only apply this behavior on mobile
            if (window.innerWidth <= 768) {
                e.preventDefault();
                const parentLi = this.parentElement;
                
                // Close all other open dropdowns
                document.querySelectorAll('.dropdown.active').forEach(item => {
                    if (item !== parentLi) {
                        item.classList.remove('active');
                    }
                });
                
                // Toggle this dropdown
                parentLi.classList.toggle('active');
            }
        });
    });
    
    // Close menu when clicking outside
    document.addEventListener('click', function(e) {
        const isClickInsideNav = navMenu.contains(e.target) || mobileToggle.contains(e.target);
        if (!isClickInsideNav && navMenu.classList.contains('active')) {
            navMenu.classList.remove('active');
            mobileToggle.classList.remove('active');
            const bars = mobileToggle.querySelectorAll('.bar');
            bars[0].style.transform = 'none';
            bars[1].style.opacity = '1';
            bars[2].style.transform = 'none';
        }
    });
    
    // Handle resize events
    window.addEventListener('resize', function() {
        if (window.innerWidth > 768) {
            navMenu.classList.remove('active');
            mobileToggle.classList.remove('active');
            const bars = mobileToggle.querySelectorAll('.bar');
            bars[0].style.transform = 'none';
            bars[1].style.opacity = '1';
            bars[2].style.transform = 'none';
            
            // Reset all dropdowns
            document.querySelectorAll('.dropdown.active').forEach(item => {
                item.classList.remove('active');
            });
        }
    });
});
        // API configuration
        const API_URL = 'api.php'; // Change this to your actual API endpoint
        
        // Global variables to store captain information
        let currentCaptain = null;
        let captainDivision = null;

        // API functions
        async function fetchApi(endpoint, params = {}) {
            const queryString = new URLSearchParams(params).toString();
            const url = `${API_URL}?endpoint=${endpoint}&${queryString}`;
            
            try {
                const response = await fetch(url);
                return await response.json();
            } catch (error) {
                console.error('API Error:', error);
                return [];
            }
        }
        
        async function postApi(endpoint, data) {
            try {
                console.log(`Sending ${endpoint} request:`, data);
                const loadingIndicator = document.getElementById('loading-indicator');
                loadingIndicator.classList.remove('hidden');
                
                const response = await fetch(`${API_URL}?endpoint=${endpoint}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                const responseText = await response.text();
                loadingIndicator.classList.add('hidden');
                console.log('Raw response:', responseText); // Debug output
                
                try {
                    return JSON.parse(responseText);
                } catch (parseError) {
                    console.error('JSON Parse Error:', parseError);
                    console.error('Response text:', responseText);
                    return { success: false, error: 'Invalid JSON response from server' };
                }
            } catch (error) {
                document.getElementById('loading-indicator').classList.add('hidden');
                console.error('API Error:', error);
                return { success: false, error: error.message };
            }
        }

        // Wait for DOM to be fully loaded before adding event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Setup the match type and cup round relationship
            const matchTypeSelect = document.getElementById('match-type');
            const cupRoundSelect = document.getElementById('cup-round');
            const cupRoundContainer = document.getElementById('cup-round-container');
            
            // Apply initial state - disable cup round by default
            cupRoundContainer.classList.add('disabled-field');
            cupRoundSelect.disabled = true;
            
            // Add event listener to match type dropdown
            matchTypeSelect.addEventListener('change', function() {
                if (this.value === 'cup') {
                    cupRoundSelect.disabled = false;
                    cupRoundContainer.classList.remove('disabled-field');
                } else {
                    cupRoundSelect.disabled = true;
                    cupRoundSelect.value = '';
                    cupRoundContainer.classList.add('disabled-field');
                }
            });
            
            // Login form handling
            const loginForm = document.getElementById('login-form-element');
            if (loginForm) {
                loginForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const username = document.getElementById('username').value;
                    const password = document.getElementById('password').value;
                    
                    console.log('Login attempt with:', { username });
                    
                    try {
                        const result = await postApi('login', { username, password });
                        
                        console.log('Login response:', result);
                        
                        if (result && result.success) {
                            // Store captain info globally for later use
                            currentCaptain = result.captain;
                            
                            // Determine team division
                            await determineTeamDivision();
                            
                            // Display team information
                            const teamInfoDiv = document.getElementById('team-info');
                            teamInfoDiv.innerHTML = `
                                <p><strong>Welcome!</strong></p>
                                <p>You are logged in as: <strong>${currentCaptain.team_name}</strong> Captain</p>
                                <p>Division: <strong>${captainDivision.toUpperCase()}</strong></p>
                            `;
                            
                            document.getElementById('login-form').classList.add('hidden');
                            document.getElementById('score-input-form').classList.remove('hidden');
                            
                            // Set the home team to the captain's team
                            const homeTeamSelect = document.getElementById('home-team');
                            homeTeamSelect.innerHTML = `<option value="${currentCaptain.team_name}">${currentCaptain.team_name}</option>`;
                            
                            // Set division based on determined division
                            document.getElementById('division').value = captainDivision;
                            
                            // Load other teams for the away team selection
                            loadAwayTeamOptions();
                            generateDoublesMatches();
                            generateSinglesMatches();
                            generateOneEightiesInputs();
                            generateHighFinishesInputs();
                        } else {
                            const errorMsg = result ? (result.error || 'Invalid credentials') : 'No response received';
                            alert('Login failed: ' + errorMsg);
                        }
                    } catch (error) {
                        console.error('Login error:', error);
                        alert('Login error: ' + error.message);
                    }
                });
            } else {
                console.error('Login form not found!');
            }

            // Set up other event listeners
            const awayTeamSelect = document.getElementById('away-team');
            if (awayTeamSelect) {
                awayTeamSelect.addEventListener('change', async () => {
                    await updatePlayerSelects('away');
                    // Update stat player options when teams change
                    document.querySelectorAll('.one-eighty-player, .high-finish-player').forEach(select => {
                        populateStatPlayerOptions(select);
                    });
                });
            }

            // Match form submission setup
            const matchForm = document.getElementById('match-form');
            if (matchForm) {
                matchForm.addEventListener('submit', submitMatchForm);
            } else {
                console.error('Match form not found!');
            }
        });

        // Determine the division of the captain's team
        async function determineTeamDivision() {
            if (!currentCaptain) {
                console.error('No captain information available');
                captainDivision = 'premier'; // Default fallback
                return;
            }
            
            try {
                // Call the teams endpoint without any division filter to get ALL teams
                const allTeams = await fetchApi('teams');
                console.log('All teams loaded for division check:', allTeams.length);
                
                // First try to find the team by team_id (most reliable method)
                if (currentCaptain.team_id) {
                    const teamById = allTeams.find(team => parseInt(team.team_id) === parseInt(currentCaptain.team_id));
                    if (teamById && teamById.division) {
                        captainDivision = teamById.division.toLowerCase();
                        console.log(`Captain's team division found by ID: ${captainDivision}`);
                        return;
                    }
                }
                
                // If team_id doesn't work, try by team name
                if (currentCaptain.team_name) {
                    const teamByName = allTeams.find(team => 
                        team.team_name.toLowerCase() === currentCaptain.team_name.toLowerCase()
                    );
                    if (teamByName && teamByName.division) {
                        captainDivision = teamByName.division.toLowerCase();
                        console.log(`Captain's team division found by name: ${captainDivision}`);
                        return;
                    }
                }
                
                // If we still don't have a division, use known A division team names
                const aDivisionTeams = [
                    'Ewhurst Arrows', 'Dingles', 'Johnson', 'Disappointers', 
                    'APV', 'Ewhurst Woodys', 'Pelham', 'Division A Bye'
                ];
                
                if (currentCaptain.team_name && 
                    aDivisionTeams.some(name => 
                        name.toLowerCase() === currentCaptain.team_name.toLowerCase()
                    )) {
                    captainDivision = 'a';
                    console.log("Team found in A division list");
                    return;
                }
                
                // Team IDs 9-16 are A division based on the schema
                if (currentCaptain.team_id && parseInt(currentCaptain.team_id) >= 9 && parseInt(currentCaptain.team_id) <= 16) {
                    captainDivision = 'a';
                    console.log("Team identified as A division by ID range");
                    return;
                }
                
                // Default to premier if all checks fail
                captainDivision = 'premier';
                console.warn(`Could not determine team division, defaulting to: ${captainDivision}`);
            } catch (error) {
                console.error('Error determining team division:', error);
                captainDivision = 'premier'; // Default to premier division
            }
        }

        // Load away team options for Submit Score
        async function loadAwayTeamOptions() {
            if (!currentCaptain) {
                console.error('No captain information available');
                return;
            }
            
            const teams = await fetchApi('teams', { division: captainDivision });
            
            const awaySelect = document.getElementById('away-team');
            const currentValue = awaySelect.value;
            
            awaySelect.innerHTML = '<option value="">Select Away Team</option>';
            
            teams.forEach(team => {
                // Add to away select if not the captain's team
                if (team.team_name !== currentCaptain.team_name) {
                    awaySelect.add(new Option(team.team_name, team.team_name));
                }
            });
            
            // Restore previously selected value if still valid
            if (currentValue && teams.some(t => t.team_name === currentValue && t.team_name !== currentCaptain.team_name)) {
                awaySelect.value = currentValue;
            }
        }

        /**
         * Gets players selected for doubles games only
         * @returns {Object} Object with home and away player sets
         */
        function getSelectedDoublesPlayers() {
            const selectedPlayers = {
                home: new Set(),
                away: new Set()
            };
            
            // Get all selected home players from doubles only
            document.querySelectorAll('.home-player1, .home-player2').forEach(select => {
                if (select.value) {
                    selectedPlayers.home.add(select.value);
                }
            });
            
            // Get all selected away players from doubles only
            document.querySelectorAll('.away-player1, .away-player2').forEach(select => {
                if (select.value) {
                    selectedPlayers.away.add(select.value);
                }
            });
            
            return selectedPlayers;
        }

        /**
         * Gets players selected for singles games only
         * @returns {Object} Object with home and away player sets
         */
        function getSelectedSinglesPlayers() {
            const selectedPlayers = {
                home: new Set(),
                away: new Set()
            };
            
            // Get all selected home players from singles only
            document.querySelectorAll('.home-player').forEach(select => {
                if (select.value) {
                    selectedPlayers.home.add(select.value);
                }
            });
            
            // Get all selected away players from singles only
            document.querySelectorAll('.away-player').forEach(select => {
                if (select.value) {
                    selectedPlayers.away.add(select.value);
                }
            });
            
            return selectedPlayers;
        }

        async function updatePlayerSelects(side) {
            // Only update away players since home team is fixed
            if (side === 'home') {
                await updateAllPlayerSelects();
                return;
            }
            
            const teamName = document.getElementById(`${side}-team`).value;
            if (!teamName) {
                // Clear player selects if no team is selected
                document.querySelectorAll(`.${side}-player, .${side}-player1, .${side}-player2`).forEach(select => {
                    select.innerHTML = '<option value="">Select Player</option>';
                });
                return;
            }
            
            // Update both singles and doubles player options
            await updateAllPlayerSelects();
        }

        /**
         * Updates player options for both singles and doubles matches
         */
        async function updateAllPlayerSelects() {
            await updateDoublesPlayerOptions();
            await updateSinglesPlayerOptions();
        }

        /**
         * Updates player options for doubles matches to exclude already selected players in doubles only
         */
        async function updateDoublesPlayerOptions() {
            const homeTeamName = currentCaptain.team_name;
            const awayTeamName = document.getElementById('away-team').value;
            
            if (!homeTeamName && !awayTeamName) return;
            
            // Get players selected in doubles matches only
            const selectedPlayers = getSelectedDoublesPlayers();
            
            if (homeTeamName) {
                const homePlayers = await fetchApi('players', { team_name: homeTeamName });
                
                document.querySelectorAll('.home-player1, .home-player2').forEach(select => {
                    const currentValue = select.value;
                    const currentSelectionExcludingThisOne = new Set(selectedPlayers.home);
                    
                    // Remove this element's selection from the list of excluded players
                    if (currentValue) {
                        currentSelectionExcludingThisOne.delete(currentValue);
                    }
                    
                    select.innerHTML = '<option value="">Select Player</option>';
                    
                    homePlayers.forEach(player => {
                        // Only add player if they're not already selected in another doubles match
                        // or if they're the currently selected player in this dropdown
                        if (!currentSelectionExcludingThisOne.has(player.player_name)) {
                            select.add(new Option(player.player_name, player.player_name));
                        }
                    });
                    
                    // Restore current value if still valid
                    if (currentValue && homePlayers.some(p => p.player_name === currentValue)) {
                        select.value = currentValue;
                    }
                });
            }
            
            if (awayTeamName) {
                const awayPlayers = await fetchApi('players', { team_name: awayTeamName });
                
                document.querySelectorAll('.away-player1, .away-player2').forEach(select => {
                    const currentValue = select.value;
                    const currentSelectionExcludingThisOne = new Set(selectedPlayers.away);
                    
                    // Remove this element's selection from the list of excluded players
                    if (currentValue) {
                        currentSelectionExcludingThisOne.delete(currentValue);
                    }
                    
                    select.innerHTML = '<option value="">Select Player</option>';
                    
                    awayPlayers.forEach(player => {
                        // Only add player if they're not already selected in another doubles match
                        // or if they're the currently selected player in this dropdown
                        if (!currentSelectionExcludingThisOne.has(player.player_name)) {
                            select.add(new Option(player.player_name, player.player_name));
                        }
                    });
                    
                    // Restore current value if still valid
                    if (currentValue && awayPlayers.some(p => p.player_name === currentValue)) {
                        select.value = currentValue;
                    }
                });
            }
        }

        /**
         * Updates player options for singles matches to exclude already selected players in singles only
         */
        async function updateSinglesPlayerOptions() {
            const homeTeamName = currentCaptain.team_name;
            const awayTeamName = document.getElementById('away-team').value;
            
            if (!homeTeamName && !awayTeamName) return;
            
            // Get players selected in singles matches only
            const selectedPlayers = getSelectedSinglesPlayers();
            
            if (homeTeamName) {
                const homePlayers = await fetchApi('players', { team_name: homeTeamName });
                
                document.querySelectorAll('.home-player').forEach(select => {
                    const currentValue = select.value;
                    const currentSelectionExcludingThisOne = new Set(selectedPlayers.home);
                    
                    // Remove this element's selection from the list of excluded players
                    if (currentValue) {
                        currentSelectionExcludingThisOne.delete(currentValue);
                    }
                    
                    select.innerHTML = '<option value="">Select Home Player</option>';
                    
                    homePlayers.forEach(player => {
                        // Only add player if they're not already selected in another singles match
                        // or if they're the currently selected player in this dropdown
                        if (!currentSelectionExcludingThisOne.has(player.player_name)) {
                            select.add(new Option(player.player_name, player.player_name));
                        }
                    });
                    
                    // Restore current value if still valid
                    if (currentValue && homePlayers.some(p => p.player_name === currentValue)) {
                        select.value = currentValue;
                    }
                });
            }
            
            if (awayTeamName) {
                const awayPlayers = await fetchApi('players', { team_name: awayTeamName });
                
                document.querySelectorAll('.away-player').forEach(select => {
                    const currentValue = select.value;
                    const currentSelectionExcludingThisOne = new Set(selectedPlayers.away);
                    
                    // Remove this element's selection from the list of excluded players
                    if (currentValue) {
                        currentSelectionExcludingThisOne.delete(currentValue);
                    }
                    
                    select.innerHTML = '<option value="">Select Away Player</option>';
                    
                    awayPlayers.forEach(player => {
                        // Only add player if they're not already selected in another singles match
                        // or if they're the currently selected player in this dropdown
                        if (!currentSelectionExcludingThisOne.has(player.player_name)) {
                            select.add(new Option(player.player_name, player.player_name));
                        }
                    });
                    
                    // Restore current value if still valid
                    if (currentValue && awayPlayers.some(p => p.player_name === currentValue)) {
                        select.value = currentValue;
                    }
                });
            }
        }

        // Generate doubles match inputs
        function generateDoublesMatches() {
            const doublesMatchesDiv = document.getElementById('doubles-matches');
            doublesMatchesDiv.innerHTML = '';
            
            // Use captain's division for match format
            const division = captainDivision;
            
            for (let i = 1; i <= 3; i++) {
                const matchDiv = document.createElement('div');
                matchDiv.className = 'doubles-match';
                
                let scoreOptions = '';
                if (division === 'premier') {
                    // Best of 5 for Premier Division (first to 3)
                    scoreOptions = `
                        <option value="3-0">3-0 (Home Win)</option>
                        <option value="3-1">3-1 (Home Win)</option>
                        <option value="3-2">3-2 (Home Win)</option>
                        <option value="2-3">2-3 (Away Win)</option>
                        <option value="1-3">1-3 (Away Win)</option>
                        <option value="0-3">0-3 (Away Win)</option>
                    `;
                } else {
                    // Best of 3 for A Division (first to 2)
                    scoreOptions = `
                        <option value="2-0">2-0 (Home Win)</option>
                        <option value="2-1">2-1 (Home Win)</option>
                        <option value="1-2">1-2 (Away Win)</option>
                        <option value="0-2">0-2 (Away Win)</option>
                    `;
                }
                
                matchDiv.innerHTML = `
                    <div class="match-header">Doubles Game ${i}</div>
                    <div class="doubles-players">
                        <div class="home-side">
                            <select class="player-select home-player1" data-match="${i}">
                                <option value="">Select Home Player 1</option>
                            </select>
                            <select class="player-select home-player2" data-match="${i}">
                                <option value="">Select Home Player 2</option>
                            </select>
                        </div>
                        <select class="score-select" data-match="${i}">
                            ${scoreOptions}
                        </select>
                        <div class="away-side">
                            <select class="player-select away-player1" data-match="${i}">
                                <option value="">Select Away Player 1</option>
                            </select>
                            <select class="player-select away-player2" data-match="${i}">
                                <option value="">Select Away Player 2</option>
                            </select>
                        </div>
                    </div>
                `;
                doublesMatchesDiv.appendChild(matchDiv);
            }
            
            // Add change event listeners to all doubles player selects after they're generated
            document.querySelectorAll('.home-player1, .home-player2, .away-player1, .away-player2').forEach(select => {
                select.addEventListener('change', updateDoublesPlayerOptions);
            });
            
            // Update player options
            updateDoublesPlayerOptions();
        }

        // Generate singles match inputs
        function generateSinglesMatches() {
            const singlesMatchesDiv = document.getElementById('singles-matches');
            singlesMatchesDiv.innerHTML = '';
            
            // Use captain's division for match format
            const division = captainDivision;
            
            for (let i = 1; i <= 6; i++) {
                const matchDiv = document.createElement('div');
                matchDiv.className = 'singles-match';
                
                let scoreOptions = '';
                if (division === 'premier') {
                    // Best of 5 for Premier Division (first to 3)
                    scoreOptions = `
                        <option value="3-0">3-0 (Home Win)</option>
                        <option value="3-1">3-1 (Home Win)</option>
                        <option value="3-2">3-2 (Home Win)</option>
                        <option value="2-3">2-3 (Away Win)</option>
                        <option value="1-3">1-3 (Away Win)</option>
                        <option value="0-3">0-3 (Away Win)</option>
                    `;
                } else {
                    // Best of 3 for A Division (first to 2)
                    scoreOptions = `
                        <option value="2-0">2-0 (Home Win)</option>
                        <option value="2-1">2-1 (Home Win)</option>
                        <option value="1-2">1-2 (Away Win)</option>
                        <option value="0-2">0-2 (Away Win)</option>
                    `;
                }
                
                matchDiv.innerHTML = `
                    <div class="match-header">Singles Game ${i}</div>
                    <div class="singles-players">
                        <div class="home-side">
                            <select class="player-select home-player" data-match="${i}">
                                <option value="">Select Home Player</option>
                            </select>
                        </div>
                        <select class="score-select" data-match="${i}">
                            ${scoreOptions}
                        </select>
                        <div class="away-side">
                            <select class="player-select away-player" data-match="${i}">
                                <option value="">Select Away Player</option>
                            </select>
                        </div>
                    </div>
                `;
                singlesMatchesDiv.appendChild(matchDiv);
            }
            
            // Add change event listeners to all singles player selects after they're generated
            document.querySelectorAll('.home-player, .away-player').forEach(select => {
                select.addEventListener('change', updateSinglesPlayerOptions);
            });
            
            // Update player options
            updateSinglesPlayerOptions();
        }

        // Generate 180s input section
        function generateOneEightiesInputs() {
            const container = document.getElementById('one-eighties-section');
            container.innerHTML = '';
            
            // Add initial input row
            addOneEightyInputRow();
            
            // Add button to add more rows
            const addButton = document.createElement('button');
            addButton.type = 'button';
            addButton.className = 'add-stat-btn';
            addButton.textContent = 'Add Another 180';
            addButton.addEventListener('click', addOneEightyInputRow);
            container.appendChild(addButton);
            
            // Initial population of player options if teams are selected
            if (currentCaptain && currentCaptain.team_name) {
                document.querySelectorAll('.one-eighty-player').forEach(select => {
                    populateStatPlayerOptions(select);
                });
            }
        }
        
        function addOneEightyInputRow() {
            const container = document.getElementById('one-eighties-section');
            const rowCount = container.querySelectorAll('.stats-row').length;
            
            const row = document.createElement('div');
            row.className = 'stats-row';
            row.innerHTML = `
                <select class="player-select one-eighty-player" data-row="${rowCount + 1}">
                    <option value="">Select Player</option>
                </select>
                <input type="number" class="one-eighty-count" value="1" min="1" placeholder="Number of 180s">
                ${rowCount > 0 ? '<button type="button" class="remove-stat-btn">Remove</button>' : ''}
            `;
            
            // Add before the add button
            const addButton = container.querySelector('.add-stat-btn');
            container.insertBefore(row, addButton);
            
            // Add remove functionality
            const removeBtn = row.querySelector('.remove-stat-btn');
            if (removeBtn) {
                removeBtn.addEventListener('click', () => row.remove());
            }
            
            // Populate player options
            populateStatPlayerOptions(row.querySelector('.one-eighty-player'));
        }
        
        // Generate high finishes input section
        function generateHighFinishesInputs() {
            const container = document.getElementById('high-finishes-section');
            container.innerHTML = '';
            
            // Add initial input row
            addHighFinishInputRow();
            
            // Add button to add more rows
            const addButton = document.createElement('button');
            addButton.type = 'button';
            addButton.className = 'add-stat-btn';
            addButton.textContent = 'Add Another High Finish';
            addButton.addEventListener('click', addHighFinishInputRow);
            container.appendChild(addButton);
            
            // Initial population of player options if teams are selected
            if (currentCaptain && currentCaptain.team_name) {
                document.querySelectorAll('.high-finish-player').forEach(select => {
                    populateStatPlayerOptions(select);
                });
            }
        }
        
        function addHighFinishInputRow() {
            const container = document.getElementById('high-finishes-section');
            const rowCount = container.querySelectorAll('.stats-row').length;
            
            const row = document.createElement('div');
            row.className = 'stats-row';
            row.innerHTML = `
                <select class="player-select high-finish-player" data-row="${rowCount + 1}">
                    <option value="">Select Player</option>
                </select>
                <input type="number" class="high-finish-value" min="100" placeholder="Finish value">
                ${rowCount > 0 ? '<button type="button" class="remove-stat-btn">Remove</button>' : ''}
            `;
            
            // Add before the add button
            const addButton = container.querySelector('.add-stat-btn');
            container.insertBefore(row, addButton);
            
            // Add remove functionality
            const removeBtn = row.querySelector('.remove-stat-btn');
            if (removeBtn) {
                removeBtn.addEventListener('click', () => row.remove());
            }
            
            // Populate player options
            populateStatPlayerOptions(row.querySelector('.high-finish-player'));
        }
        
        // Populate player options for stats
        async function populateStatPlayerOptions(select) {
            const homeTeam = currentCaptain ? currentCaptain.team_name : '';
            const awayTeam = document.getElementById('away-team').value;
            
            // Clear existing options except the first one
            select.innerHTML = '<option value="">Select Player</option>';
            
            if (homeTeam) {
                const homePlayers = await fetchApi('players', { team_name: homeTeam });
                homePlayers.forEach(player => {
                    select.add(new Option(`${player.player_name} (${homeTeam})`, player.player_name));
                });
            }
            
            if (awayTeam) {
                const awayPlayers = await fetchApi('players', { team_name: awayTeam });
                awayPlayers.forEach(player => {
                    select.add(new Option(`${player.player_name} (${awayTeam})`, player.player_name));
                });
            }
        }

        // Match form submission
        async function submitMatchForm(e) {
            e.preventDefault();
            
            if (!currentCaptain || !currentCaptain.team_name) {
                alert('You need to be logged in to submit scores.');
                return;
            }
            
            const matchData = {
                division: document.getElementById('division').value,
                matchType: document.getElementById('match-type').value,
                homeTeam: currentCaptain.team_name, // Always use captain's team
                awayTeam: document.getElementById('away-team').value,
                doubles: [],
                singles: [],
                oneEighties: [],
                highFinishes: []
            };
            
            // Add cup round if it's a cup match
            if (matchData.matchType === 'cup') {
                const cupRound = document.getElementById('cup-round').value;
                if (!cupRound) {
                    alert('Please select a Cup Round for cup matches.');
                    return;
                }
                matchData.cupRound = cupRound;
            }
            
            // Validate required fields
            if (!matchData.division || !matchData.matchType || !matchData.homeTeam || !matchData.awayTeam) {
                alert('Please select division, match type, and away team.');
                return;
            }

            // Collect doubles match data
            document.querySelectorAll('.doubles-match').forEach((match, index) => {
                const homePlayer1 = match.querySelector('.home-player1').value;
                const homePlayer2 = match.querySelector('.home-player2').value;
                const awayPlayer1 = match.querySelector('.away-player1').value;
                const awayPlayer2 = match.querySelector('.away-player2').value;
                const score = match.querySelector('.score-select').value;
                
                if (homePlayer1 && homePlayer2 && awayPlayer1 && awayPlayer2 && score) {
                    matchData.doubles.push({
                        homePlayer1,
                        homePlayer2,
                        awayPlayer1,
                        awayPlayer2,
                        score
                    });
                }
            });

            // Collect singles match data
            document.querySelectorAll('.singles-match').forEach((match, index) => {
                const homePlayer = match.querySelector('.home-player').value;
                const awayPlayer = match.querySelector('.away-player').value;
                const score = match.querySelector('.score-select').value;
                
                if (homePlayer && awayPlayer && score) {
                    matchData.singles.push({
                        homePlayer,
                        awayPlayer,
                        score
                    });
                }
            });
            
            // Collect 180s data
            document.querySelectorAll('#one-eighties-section .stats-row').forEach(row => {
                const player = row.querySelector('.one-eighty-player').value;
                const count = row.querySelector('.one-eighty-count').value;
                
                if (player && count) {
                    matchData.oneEighties.push({
                        player,
                        count: parseInt(count)
                    });
                }
            });
            
            // Collect high finishes data
            document.querySelectorAll('#high-finishes-section .stats-row').forEach(row => {
                const player = row.querySelector('.high-finish-player').value;
                const value = row.querySelector('.high-finish-value').value;
                
                if (player && value) {
                    matchData.highFinishes.push({
                        player,
                        value: parseInt(value)
                    });
                }
            });
            
            // Validate that at least one game is complete
            if (matchData.doubles.length === 0 && matchData.singles.length === 0) {
                alert('Please enter scores for at least one game.');
                return;
            }
            
            console.log('Submitting match data:', matchData); // Debug output

            const result = await postApi('submit-match', matchData);
            
            if (result.success) {
                alert('Match score submitted successfully!');
                
                // Reset form fields but keep the home team (captain's team)
                const homeTeam = document.getElementById('home-team').value;
                const division = document.getElementById('division').value;
                
                document.getElementById('match-form').reset();
                
                // Restore values
                document.getElementById('division').value = division;
                document.getElementById('home-team').value = homeTeam;
                document.getElementById('home-team').disabled = true;
                
                // Reset cup round selection
                document.getElementById('cup-round').value = '';
                document.getElementById('cup-round').disabled = true;
                document.getElementById('cup-round-container').classList.add('disabled-field');
                
                // Reload form elements
                loadAwayTeamOptions();
                generateDoublesMatches();
                generateSinglesMatches();
                generateOneEightiesInputs();
                generateHighFinishesInputs();
            } else {
                alert('Error submitting match: ' + (result.error || 'Unknown error'));
                console.error('Error details:', result);
            }
        }
    </script>
</body>
</html>