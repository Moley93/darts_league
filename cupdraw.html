<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Tournament Bracket Generator for UK Darts Cups - Create seeded or random draws for up to 64 players">
    <meta property="og:title" content="CDL | Cup Draw Generator">
    <meta property="og:description" content="Tournament Bracket Generator for the Crawley Darts League. Create seeded or random draws for up to 64 players.">
    <meta property="og:image" content="https://crawleydartsleague.com/cdl-logo.png">
    <title>CDL | Cup Draw Generator</title>
    <link rel="icon" href="cdl.png">
    <style>
        :root {
            --primary: #1a237e;
            --secondary: #3949ab;
            --light-gray: #f5f5f5;
            --medium-gray: #e0e0e0;
            --dark-gray: #757575;
            --card-bg: #ffffff;
            --success: #4caf50;
            --warning: #ff9800;
            --error: #f44336;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: var(--light-gray);
        }

        /* Header Styles */
        .header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 15px 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        .logo-container {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
        }

        .logo {
            width: 60px;
            height: 58px;
            object-fit: contain;
        }

        .header h1 {
            margin: 0;
            text-align: center;
            font-size: 1.5rem;
        }

        .mobile-toggle {
            display: none;
            background: transparent;
            border: none;
            cursor: pointer;
            padding: 10px;
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            z-index: 10;
        }

        .mobile-toggle .bar {
            display: block;
            width: 25px;
            height: 3px;
            margin: 5px auto;
            background-color: white;
            transition: all 0.3s ease;
        }

        /* Navigation Styles */
        .nav {
            background-color: white;
            position: relative;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .nav-menu {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
        }

        .nav-menu > li {
            position: relative;
            margin: 0;
        }

        .nav-menu > li > a {
            display: block;
            padding: 15px;
            color: var(--primary);
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .nav-menu > li > a:hover {
            background-color: var(--light-gray);
        }

        .dropdown {
            position: relative;
        }

        .dropdown-toggle:after {
            content: "▼";
            font-size: 0.7em;
            margin-left: 5px;
            vertical-align: middle;
        }

        .dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            background-color: white;
            min-width: 200px;
            padding: 5px 0;
            margin: 0;
            list-style: none;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border-radius: 0 0 4px 4px;
            z-index: 100;
            opacity: 0;
            visibility: hidden;
            transform: translateY(10px);
            transition: all 0.3s ease;
        }

        .dropdown:hover .dropdown-menu,
        .dropdown:focus-within .dropdown-menu {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .dropdown-menu li {
            margin: 0;
        }

        .dropdown-menu a {
            display: block;
            padding: 10px 15px;
            color: var(--primary);
            text-decoration: none;
            transition: all 0.3s ease;
        }

        .dropdown-menu a:hover {
            background-color: var(--light-gray);
        }

        /* Main Content */
        .container {
            max-width: 1400px;
            margin: 20px auto;
            padding: 0 20px;
        }

        .card {
            background: var(--card-bg);
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 20px;
            margin-bottom: 20px;
        }

        .card h2 {
            color: var(--primary);
            margin-bottom: 15px;
            font-size: 1.5rem;
        }

        .card h3 {
            color: var(--secondary);
            margin-bottom: 10px;
            font-size: 1.2rem;
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: var(--primary);
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--medium-gray);
            border-radius: 4px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--secondary);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
            font-family: monospace;
        }

        .form-help {
            font-size: 0.85rem;
            color: var(--dark-gray);
            margin-top: 5px;
        }

        /* Button Styles */
        .btn {
            display: inline-block;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            text-align: center;
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--secondary);
        }

        .btn-secondary {
            background-color: var(--medium-gray);
            color: var(--primary);
        }

        .btn-secondary:hover {
            background-color: var(--dark-gray);
            color: white;
        }

        .btn-success {
            background-color: var(--success);
            color: white;
        }

        .btn-success:hover {
            background-color: #45a049;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        /* Match Length Controls */
        .match-length-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .match-length-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .match-length-item label {
            flex: 1;
            margin: 0;
        }

        .match-length-item input {
            width: 80px;
            padding: 5px;
        }

        /* Bracket Styles */
        .bracket-container {
            overflow-x: auto;
            padding: 20px 0;
        }

        .bracket {
            display: flex;
            gap: 40px;
            min-width: max-content;
        }

        .bracket-round {
            display: flex;
            flex-direction: column;
            justify-content: space-around;
            min-height: 600px;
        }

        .bracket-round h4 {
            text-align: center;
            color: var(--primary);
            margin-bottom: 20px;
            font-size: 1.1rem;
            position: sticky;
            top: 0;
            background: white;
            padding: 10px 0;
            z-index: 10;
        }

        .bracket-matches {
            display: flex;
            flex-direction: column;
            justify-content: space-around;
            flex: 1;
        }

        .bracket-match {
            background: white;
            border: 2px solid var(--medium-gray);
            border-radius: 4px;
            padding: 10px;
            min-width: 185px;
            margin: 5px 0;
            transition: all 0.3s ease;
        }

        .bracket-match:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            border-color: var(--secondary);
        }

        .match-number {
            font-size: 0.75rem;
            color: var(--dark-gray);
            font-weight: bold;
            margin-bottom: 5px;
        }

        .match-info {
            font-size: 0.7rem;
            color: var(--dark-gray);
            margin-bottom: 8px;
        }

        .match-player {
            padding: 8px;
            border: 1px solid var(--medium-gray);
            border-radius: 3px;
            margin-bottom: 5px;
            font-size: 0.9rem;
            background: var(--light-gray);
        }

        .match-player:last-child {
            margin-bottom: 0;
        }

        .match-player.bye {
            color: var(--dark-gray);
            font-style: italic;
        }

        .match-player.auto-advance {
            background: #e8f5e9;
            border-color: var(--success);
            font-weight: 500;
        }

        .match-player.clickable {
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .match-player.clickable:hover {
            background: #fff9c4;
            border-color: var(--warning);
            transform: translateX(3px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .match-player.selected-winner {
            background: #c8e6c9;
            border-color: var(--success);
            border-width: 2px;
            font-weight: 600;
        }

        .player-seed {
            display: inline-block;
            background: var(--primary);
            color: white;
            border-radius: 3px;
            padding: 2px 6px;
            font-size: 0.75rem;
            margin-right: 5px;
            font-weight: bold;
        }

        /* Info Box */
        .info-box {
            background: #e3f2fd;
            border-left: 4px solid var(--secondary);
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
        }

        .info-box h4 {
            color: var(--primary);
            margin-bottom: 10px;
        }

        .info-box ul {
            margin-left: 20px;
        }

        .info-box li {
            margin-bottom: 5px;
        }

        /* Stats Display */
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-item {
            background: var(--light-gray);
            padding: 15px;
            border-radius: 4px;
            text-align: center;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary);
        }

        .stat-label {
            font-size: 0.9rem;
            color: var(--dark-gray);
            margin-top: 5px;
        }

        /* Print Styles */
        @media print {
            body {
                background: white;
            }

            .header,
            .nav,
            .no-print {
                display: none !important;
            }

            .card {
                box-shadow: none;
                page-break-inside: avoid;
            }

            .bracket-container {
                overflow: visible;
            }

            .bracket {
                font-size: 0.8rem;
            }

            .bracket-match {
                border: 1px solid #000;
                page-break-inside: avoid;
            }

            .match-player.clickable {
                cursor: default;
            }

            .match-player.clickable:hover {
                background: var(--light-gray);
                border-color: var(--medium-gray);
                transform: none;
            }
        }

        /* Mobile Responsive */
        @media screen and (max-width: 768px) {
            .header h1 {
                font-size: 1.2rem;
            }

            .mobile-toggle {
                display: block;
            }

            .nav-menu {
                flex-direction: column;
                position: absolute;
                top: 100%;
                left: 0;
                width: 100%;
                background-color: white;
                box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                max-height: 0;
                overflow: hidden;
                transition: max-height 0.5s ease;
                z-index: 100;
            }

            .nav-menu.active {
                max-height: 1000px;
            }

            .dropdown-menu {
                position: static;
                box-shadow: none;
                opacity: 1;
                visibility: visible;
                transform: none;
                max-height: 0;
                overflow: hidden;
                transition: max-height 0.3s ease;
            }

            .dropdown.active .dropdown-menu {
                max-height: 500px;
            }

            .dropdown-toggle:after {
                float: right;
            }

            .dropdown.active .dropdown-toggle:after {
                content: "▲";
            }

            .nav-menu > li {
                border-bottom: 1px solid var(--light-gray);
            }

            .dropdown-menu li {
                background-color: var(--light-gray);
                padding-left: 15px;
            }

            .logo {
                width: 50px;
                height: 48px;
            }

            .bracket {
                gap: 20px;
            }

            .bracket-match {
                min-width: 145px;
            }

            .match-length-controls {
                grid-template-columns: 1fr;
            }
        }

        /* Loading Spinner */
        .spinner {
            border: 4px solid var(--light-gray);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none;
        }

        /* Alert Messages */
        .alert {
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            border-left: 4px solid;
        }

        .alert-success {
            background: #e8f5e9;
            border-color: var(--success);
            color: #2e7d32;
        }

        .alert-error {
            background: #ffebee;
            border-color: var(--error);
            color: #c62828;
        }

        .alert-warning {
            background: #fff3e0;
            border-color: var(--warning);
            color: #e65100;
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="logo-container">
            <img src="cdl-logo.png" alt="Crawley Darts League Logo" class="logo" onerror="this.style.display='none'">
        </div>
        <h1>Crawley Darts League</h1>
        <button class="mobile-toggle" aria-label="Toggle menu">
            <span class="bar"></span>
            <span class="bar"></span>
            <span class="bar"></span>
        </button>
    </header>

    <nav class="nav">
        <ul class="nav-menu">
            <li><a href="index.html">Home</a></li>
            <li class="dropdown">
                <a href="#" class="dropdown-toggle">League</a>
                <ul class="dropdown-menu">
                    <li><a href="leaguetable.html">League Table</a></li>
                    <li><a href="leaguefixtures.html">Fixtures</a></li>
                    <li><a href="leagueresults.html">Results</a></li>
                </ul>
            </li>
            <li class="dropdown">
                <a href="#" class="dropdown-toggle">Competitions</a>
                <ul class="dropdown-menu">
                    <li><a href="knockoutcup.html">Knockout Cup</a></li>
                    <li><a href="singlescup.html">Singles Cup</a></li>
                    <li><a href="pairscup.html">Pairs Cup</a></li>
                    <li><a href="treblescup.html">Trebles Cup</a></li>
                    <li><a href="captainscup.html">Captains Cup</a></li>
                    <li><a href="goodfridaycup.html">Good Friday Cup</a></li>
                    <li><a href="charitycup.html">Charity Cup</a></li>
                    <li><a href="cupdraw.html">Bracket Generator</a></li>
                </ul>
            </li>
            <li class="dropdown">
                <a href="#" class="dropdown-toggle">Statistics</a>
                <ul class="dropdown-menu">
                    <li><a href="180sfinishes.html">180s & High Finishes</a></li>
                    <li><a href="playerrankings.html">Player Rankings</a></li>
                </ul>
            </li>
            <li class="dropdown">
                <a href="#" class="dropdown-toggle">Information</a>
                <ul class="dropdown-menu">
                    <li><a href="contactinfo.html">Contacts & Venues</a></li>
                    <li><a href="rules.html">League Rules</a></li>
                    <li><a href="agm-minutes.html">AGM Minutes</a></li>
                    <li><a href="players.html">Players</a></li>
                </ul>
            </li>
            <li class="dropdown">
                <a href="#" class="dropdown-toggle">Submit Score</a>
                <ul class="dropdown-menu">
                    <li><a href="scoreinput.html">Submit Score</a></li>
                    <li><a href="editscores.html">Edit Score</a></li>
                </ul>
            </li>
            <li class="dropdown">
                <a href="#" class="dropdown-toggle">Join</a>
                <ul class="dropdown-menu">
                    <li><a href="registration.html">Registration Form</a></li>
                    <li><a href="findateam.html">Find a Team</a></li>
                </ul>
            </li>
        </ul>
    </nav>

    <div class="container">
        <!-- Setup Section -->
        <div class="card no-print" id="setupSection">
            <h2>Tournament Setup</h2>

            <div class="info-box">
                <h4>How It Works</h4>
                <ul>
                    <li><strong>Field size:</strong> Up to 64 players. BYEs inserted automatically if fewer.</li>
                    <li><strong>Seeded draw:</strong> Seeds follow standard snake pattern. BYEs given to highest seeds first.</li>
                    <li><strong>Random draw:</strong> All players shuffled; BYEs spaced evenly.</li>
                    <li><strong>Interactive bracket:</strong> Click on a player's name to advance them to the next round.</li>
                    <li><strong>Throw procedure:</strong> Bull for first leg throw; alternate thereafter. Decider leg: bull again.</li>
                </ul>
            </div>

            <div class="form-group">
                <label for="entrants">Entrants (one per line)</label>
                <textarea id="entrants" placeholder="Enter player names, one per line...&#10;Example:&#10;John Smith&#10;Jane Doe&#10;Mike Johnson"></textarea>
                <div class="form-help">Enter between 2 and 64 player names, one per line.</div>
            </div>

            <div class="form-group">
                <label for="seeds">Seeds (optional, format: Name=Seed)</label>
                <textarea id="seeds" placeholder="Optional - for seeded draws only&#10;Format: Name=Seed (one per line)&#10;Example:&#10;John Smith=1&#10;Jane Doe=2&#10;Mike Johnson=3"></textarea>
                <div class="form-help">Optional: Specify seeds in format "Name=1", "Name=2", etc. Unseeded players placed randomly.</div>
            </div>

            <div class="form-group">
                <label for="drawType">Draw Type</label>
                <select id="drawType">
                    <option value="seeded">Seeded Draw (Snake Pattern)</option>
                    <option value="random">Random Draw</option>
                </select>
            </div>

            <h3>Match Length Settings</h3>
            <div class="match-length-controls">
                <div class="match-length-item">
                    <label>R1 & R2:</label>
                    <input type="number" id="lengthR1R2" value="7" min="1" max="21" step="2">
                    <span>legs</span>
                </div>
                <div class="match-length-item">
                    <label>Last 16 & QF:</label>
                    <input type="number" id="lengthL16QF" value="9" min="1" max="21" step="2">
                    <span>legs</span>
                </div>
                <div class="match-length-item">
                    <label>Semi-Finals:</label>
                    <input type="number" id="lengthSF" value="11" min="1" max="21" step="2">
                    <span>legs</span>
                </div>
                <div class="match-length-item">
                    <label>Final:</label>
                    <input type="number" id="lengthFinal" value="13" min="1" max="21" step="2">
                    <span>legs</span>
                </div>
            </div>

            <div class="btn-group" style="margin-top: 20px;">
                <button class="btn btn-primary" onclick="generateDraw()">Generate Draw</button>
                <button class="btn btn-secondary" onclick="clearForm()">Clear</button>
                <button class="btn btn-secondary" onclick="loadSampleData()">Load Sample Data</button>
            </div>

            <div id="alertContainer"></div>
        </div>

        <!-- Results Section -->
        <div class="card no-print hidden" id="resultsSection">
            <h2>Draw Statistics</h2>
            <div class="stats" id="statsContainer"></div>

            <div class="btn-group">
                <button class="btn btn-success" onclick="window.print()">Print Bracket</button>
                <button class="btn btn-primary" onclick="exportJSON()">Export JSON</button>
                <button class="btn btn-primary" onclick="exportCSV()">Export CSV</button>
                <button class="btn btn-secondary" onclick="resetResults()">Reset Results</button>
                <button class="btn btn-secondary" onclick="showSetup()">New Draw</button>
            </div>
        </div>

        <!-- Bracket Display -->
        <div class="card hidden" id="bracketSection">
            <h2>Tournament Bracket</h2>
            <div class="bracket-container" id="bracketContainer"></div>
        </div>
    </div>

    <script>
        // ============================================
        // CORE DATA STRUCTURES AND CONSTANTS
        // ============================================

        // Standard seeded draw slot mapping (snake pattern)
        // This ensures seeds 1 and 2 are at opposite ends, proper distribution of seeds
        const SEEDED_SLOTS = [
            1, 64, 32, 33, 16, 49, 17, 48, 8, 57, 25, 40, 9, 56, 24, 41,
            4, 61, 29, 36, 13, 52, 20, 45, 5, 60, 28, 37, 12, 53, 21, 44,
            2, 63, 31, 34, 15, 50, 18, 47, 7, 58, 26, 39, 10, 55, 23, 42,
            3, 62, 30, 35, 14, 51, 19, 46, 6, 59, 27, 38, 11, 54, 22, 43
        ];

        // Round definitions
        const ROUNDS = [
            { name: 'Round 1', shortName: 'R1', matchStart: 1, matchEnd: 32, matchCount: 32 },
            { name: 'Round 2', shortName: 'R2', matchStart: 33, matchEnd: 48, matchCount: 16 },
            { name: 'Last 16', shortName: 'R3', matchStart: 49, matchEnd: 56, matchCount: 8 },
            { name: 'Quarter Finals', shortName: 'QF', matchStart: 57, matchEnd: 60, matchCount: 4 },
            { name: 'Semi Finals', shortName: 'SF', matchStart: 61, matchEnd: 62, matchCount: 2 },
            { name: 'Final', shortName: 'F', matchStart: 63, matchEnd: 63, matchCount: 1 }
        ];

        // Global state
        let currentDraw = null;

        // ============================================
        // UTILITY FUNCTIONS
        // ============================================

        /**
         * Calculate which match number feeds into from the current match
         * @param {number} matchNum - Current match number (1-63)
         * @returns {number|null} - Next match number or null if final
         */
        function nextMatchNumber(matchNum) {
            if (matchNum >= 1 && matchNum <= 32) {
                // R1 → R2
                return 33 + Math.floor((matchNum - 1) / 2);
            } else if (matchNum >= 33 && matchNum <= 48) {
                // R2 → R3
                return 49 + Math.floor((matchNum - 33) / 2);
            } else if (matchNum >= 49 && matchNum <= 56) {
                // R3 → QF
                return 57 + Math.floor((matchNum - 49) / 2);
            } else if (matchNum >= 57 && matchNum <= 60) {
                // QF → SF
                return 61 + Math.floor((matchNum - 57) / 2);
            } else if (matchNum >= 61 && matchNum <= 62) {
                // SF → F
                return 63;
            } else if (matchNum === 63) {
                // Final
                return null;
            }
            return null;
        }

        /**
         * Get match length (best of X legs) for a given match number
         */
        function getMatchLength(matchNum) {
            const lengthR1R2 = parseInt(document.getElementById('lengthR1R2').value) || 7;
            const lengthL16QF = parseInt(document.getElementById('lengthL16QF').value) || 9;
            const lengthSF = parseInt(document.getElementById('lengthSF').value) || 11;
            const lengthFinal = parseInt(document.getElementById('lengthFinal').value) || 13;

            if (matchNum >= 1 && matchNum <= 48) return lengthR1R2;
            if (matchNum >= 49 && matchNum <= 60) return lengthL16QF;
            if (matchNum >= 61 && matchNum <= 62) return lengthSF;
            if (matchNum === 63) return lengthFinal;
            return 7;
        }

        /**
         * Get round name for a match number
         */
        function getRoundName(matchNum) {
            for (let round of ROUNDS) {
                if (matchNum >= round.matchStart && matchNum <= round.matchEnd) {
                    return round.name;
                }
            }
            return 'Unknown';
        }

        /**
         * Shuffle array (Fisher-Yates algorithm)
         */
        function shuffleArray(array) {
            const arr = [...array];
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
            return arr;
        }

        /**
         * Show alert message
         */
        function showAlert(message, type = 'success') {
            const alertContainer = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            alertContainer.innerHTML = '';
            alertContainer.appendChild(alert);

            setTimeout(() => {
                alert.remove();
            }, 5000);
        }

        // ============================================
        // DRAW GENERATION LOGIC
        // ============================================

        /**
         * Parse entrants from textarea
         */
        function parseEntrants() {
            const text = document.getElementById('entrants').value;
            const lines = text.split('\n')
                .map(line => line.trim())
                .filter(line => line.length > 0);

            // Remove duplicates
            return [...new Set(lines)];
        }

        /**
         * Parse seeds from textarea
         */
        function parseSeeds() {
            const text = document.getElementById('seeds').value;
            const lines = text.split('\n')
                .map(line => line.trim())
                .filter(line => line.length > 0);

            const seeds = {};
            for (let line of lines) {
                const parts = line.split('=');
                if (parts.length === 2) {
                    const name = parts[0].trim();
                    const seed = parseInt(parts[1].trim());
                    if (!isNaN(seed) && seed > 0) {
                        seeds[name] = seed;
                    }
                }
            }
            return seeds;
        }

        /**
         * Create a seeded draw
         */
        function createSeededDraw(entrants, seeds) {
            const slots = new Array(64).fill(null);
            const numEntrants = entrants.length;
            const numByes = 64 - numEntrants;

            // Separate seeded and unseeded players
            const seededPlayers = [];
            const unseededPlayers = [];

            for (let name of entrants) {
                if (seeds[name]) {
                    seededPlayers.push({ name, seed: seeds[name] });
                } else {
                    unseededPlayers.push({ name, seed: null });
                }
            }

            // Sort seeded players by seed
            seededPlayers.sort((a, b) => a.seed - b.seed);

            // Place seeded players according to SEEDED_SLOTS mapping
            for (let player of seededPlayers) {
                if (player.seed <= 64) {
                    const slotIndex = SEEDED_SLOTS.indexOf(player.seed);
                    if (slotIndex !== -1) {
                        slots[slotIndex] = player;
                    }
                }
            }

            // Shuffle unseeded players
            const shuffledUnseeded = shuffleArray(unseededPlayers);

            // Fill remaining slots with unseeded players
            let unseededIndex = 0;
            for (let i = 0; i < 64 && unseededIndex < shuffledUnseeded.length; i++) {
                if (slots[i] === null) {
                    slots[i] = shuffledUnseeded[unseededIndex++];
                }
            }

            // Fill remaining empty slots with BYEs (these go to highest seeds)
            for (let i = 0; i < 64; i++) {
                if (slots[i] === null) {
                    slots[i] = { name: 'BYE', seed: null, isBye: true };
                }
            }

            return slots;
        }

        /**
         * Create a random draw
         */
        function createRandomDraw(entrants) {
            const slots = new Array(64).fill(null);
            const numEntrants = entrants.length;
            const numByes = 64 - numEntrants;

            // Create players array
            const players = entrants.map(name => ({ name, seed: null }));

            // Shuffle all players
            const shuffled = shuffleArray(players);

            // Place players in first N slots
            for (let i = 0; i < shuffled.length; i++) {
                slots[i] = shuffled[i];
            }

            // Space BYEs evenly across remaining slots
            if (numByes > 0) {
                const byeInterval = 64 / numByes;
                let byeCount = 0;

                for (let i = 0; i < 64 && byeCount < numByes; i++) {
                    const targetSlot = Math.floor(i * byeInterval);
                    if (targetSlot < 64 && slots[targetSlot] === null) {
                        slots[targetSlot] = { name: 'BYE', seed: null, isBye: true };
                        byeCount++;
                    }
                }

                // Fill any remaining null slots with BYEs
                for (let i = 0; i < 64 && byeCount < numByes; i++) {
                    if (slots[i] === null) {
                        slots[i] = { name: 'BYE', seed: null, isBye: true };
                        byeCount++;
                    }
                }
            }

            return slots;
        }

        /**
         * Generate matches from slots
         */
        function generateMatches(slots) {
            const matches = [];

            // Round 1: 32 matches (slots pair up: 1 vs 64, 2 vs 63, etc.)
            for (let i = 0; i < 32; i++) {
                const player1 = slots[i];
                const player2 = slots[63 - i];

                const matchNum = i + 1;
                const nextMatch = nextMatchNumber(matchNum);
                const matchLength = getMatchLength(matchNum);

                // Check for auto-advance (one player is BYE)
                let winner = null;
                if (player1.isBye && !player2.isBye) {
                    winner = player2;
                } else if (!player1.isBye && player2.isBye) {
                    winner = player1;
                }

                matches.push({
                    matchNumber: matchNum,
                    round: getRoundName(matchNum),
                    player1,
                    player2,
                    winner,
                    nextMatch,
                    matchLength
                });
            }

            // Rounds 2-6: Generate empty matches with proper progression
            for (let matchNum = 33; matchNum <= 63; matchNum++) {
                matches.push({
                    matchNumber: matchNum,
                    round: getRoundName(matchNum),
                    player1: null,
                    player2: null,
                    winner: null,
                    nextMatch: nextMatchNumber(matchNum),
                    matchLength: getMatchLength(matchNum)
                });
            }

            // Propagate auto-advances through the bracket
            propagateAutoAdvances(matches);

            return matches;
        }

        /**
         * Propagate auto-advances through the bracket
         */
        function propagateAutoAdvances(matches) {
            let changed = true;
            let iterations = 0;
            const maxIterations = 10; // Prevent infinite loops

            while (changed && iterations < maxIterations) {
                changed = false;
                iterations++;

                for (let match of matches) {
                    if (match.winner && match.nextMatch) {
                        const nextMatchObj = matches.find(m => m.matchNumber === match.nextMatch);
                        if (nextMatchObj) {
                            // Determine which slot in next match
                            const feedsIntoPlayer1 = (match.matchNumber % 2 === 1);

                            if (feedsIntoPlayer1 && !nextMatchObj.player1) {
                                nextMatchObj.player1 = match.winner;
                                changed = true;

                                // Check if opponent is BYE, auto-advance
                                if (nextMatchObj.player2 && nextMatchObj.player2.isBye) {
                                    nextMatchObj.winner = match.winner;
                                }
                            } else if (!feedsIntoPlayer1 && !nextMatchObj.player2) {
                                nextMatchObj.player2 = match.winner;
                                changed = true;

                                // Check if opponent is BYE, auto-advance
                                if (nextMatchObj.player1 && nextMatchObj.player1.isBye) {
                                    nextMatchObj.winner = match.winner;
                                }
                            }
                        }
                    }
                }
            }
        }

        /**
         * Main draw generation function
         */
        function generateDraw() {
            // Parse input
            const entrants = parseEntrants();
            const seeds = parseSeeds();
            const drawType = document.getElementById('drawType').value;

            // Validation
            if (entrants.length < 2) {
                showAlert('Please enter at least 2 entrants.', 'error');
                return;
            }

            if (entrants.length > 64) {
                showAlert('Maximum 64 entrants allowed.', 'error');
                return;
            }

            // Generate slots
            let slots;
            if (drawType === 'seeded') {
                slots = createSeededDraw(entrants, seeds);
            } else {
                slots = createRandomDraw(entrants);
            }

            // Generate matches
            const matches = generateMatches(slots);

            // Store draw
            currentDraw = {
                entrants: entrants.length,
                byes: 64 - entrants.length,
                drawType,
                matches,
                timestamp: new Date().toISOString()
            };

            // Display
            displayStats();
            displayBracket();

            // Show results section
            document.getElementById('setupSection').classList.add('hidden');
            document.getElementById('resultsSection').classList.remove('hidden');
            document.getElementById('bracketSection').classList.remove('hidden');

            showAlert('Draw generated successfully!', 'success');
        }

        // ============================================
        // DISPLAY FUNCTIONS
        // ============================================

        /**
         * Display statistics
         */
        function displayStats() {
            const statsContainer = document.getElementById('statsContainer');
            const autoAdvances = currentDraw.matches.filter(m => m.winner !== null).length;

            statsContainer.innerHTML = `
                <div class="stat-item">
                    <div class="stat-value">${currentDraw.entrants}</div>
                    <div class="stat-label">Entrants</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${currentDraw.byes}</div>
                    <div class="stat-label">BYEs</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${autoAdvances}</div>
                    <div class="stat-label">Auto-Advances</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${currentDraw.drawType === 'seeded' ? 'Seeded' : 'Random'}</div>
                    <div class="stat-label">Draw Type</div>
                </div>
            `;
        }

        /**
         * Display bracket
         */
        function displayBracket() {
            const container = document.getElementById('bracketContainer');
            container.innerHTML = '';

            const bracket = document.createElement('div');
            bracket.className = 'bracket';

            // Create each round
            for (let round of ROUNDS) {
                const roundDiv = document.createElement('div');
                roundDiv.className = 'bracket-round';

                const roundTitle = document.createElement('h4');
                roundTitle.textContent = round.name;
                roundDiv.appendChild(roundTitle);

                const matchesDiv = document.createElement('div');
                matchesDiv.className = 'bracket-matches';

                // Get matches for this round
                const roundMatches = currentDraw.matches.filter(
                    m => m.matchNumber >= round.matchStart && m.matchNumber <= round.matchEnd
                );

                for (let match of roundMatches) {
                    matchesDiv.appendChild(createMatchElement(match));
                }

                roundDiv.appendChild(matchesDiv);
                bracket.appendChild(roundDiv);
            }

            container.appendChild(bracket);
        }

        /**
         * Create match element
         */
        function createMatchElement(match) {
            const matchDiv = document.createElement('div');
            matchDiv.className = 'bracket-match';
            matchDiv.dataset.matchNumber = match.matchNumber;

            const matchNumber = document.createElement('div');
            matchNumber.className = 'match-number';
            matchNumber.textContent = `Match ${match.matchNumber}`;
            matchDiv.appendChild(matchNumber);

            const matchInfo = document.createElement('div');
            matchInfo.className = 'match-info';
            matchInfo.textContent = `Best of ${match.matchLength} legs`;
            if (match.nextMatch) {
                matchInfo.textContent += ` → M${match.nextMatch}`;
            }
            matchDiv.appendChild(matchInfo);

            // Check if match is playable (both players present and not already decided)
            const isPlayable = match.player1 && match.player2 &&
                              !match.player1.isBye && !match.player2.isBye &&
                              !match.manualWinner;

            // Player 1
            if (match.player1) {
                const isWinner = match.winner === match.player1 || match.manualWinner === match.player1;
                matchDiv.appendChild(createPlayerElement(match.player1, isWinner, match.matchNumber, 1, isPlayable));
            } else {
                const placeholder = document.createElement('div');
                placeholder.className = 'match-player';
                placeholder.textContent = 'TBD';
                matchDiv.appendChild(placeholder);
            }

            // Player 2
            if (match.player2) {
                const isWinner = match.winner === match.player2 || match.manualWinner === match.player2;
                matchDiv.appendChild(createPlayerElement(match.player2, isWinner, match.matchNumber, 2, isPlayable));
            } else {
                const placeholder = document.createElement('div');
                placeholder.className = 'match-player';
                placeholder.textContent = 'TBD';
                matchDiv.appendChild(placeholder);
            }

            return matchDiv;
        }

        /**
         * Create player element
         */
        function createPlayerElement(player, isWinner, matchNumber, playerSlot, isClickable) {
            const playerDiv = document.createElement('div');
            playerDiv.className = 'match-player';

            if (player.isBye) {
                playerDiv.classList.add('bye');
                playerDiv.textContent = 'BYE';
            } else {
                // Add auto-advance styling for BYE winners
                if (isWinner && !isClickable) {
                    playerDiv.classList.add('auto-advance');
                }

                // Add selected-winner styling for manual winners
                if (isWinner && isClickable) {
                    playerDiv.classList.add('selected-winner');
                }

                // Make clickable if match is playable
                if (isClickable) {
                    playerDiv.classList.add('clickable');
                    playerDiv.dataset.matchNumber = matchNumber;
                    playerDiv.dataset.playerSlot = playerSlot;
                    playerDiv.addEventListener('click', handlePlayerClick);
                }

                if (player.seed) {
                    const seedSpan = document.createElement('span');
                    seedSpan.className = 'player-seed';
                    seedSpan.textContent = player.seed;
                    playerDiv.appendChild(seedSpan);
                }

                const nameSpan = document.createElement('span');
                nameSpan.textContent = player.name;
                playerDiv.appendChild(nameSpan);

                if (isWinner) {
                    const advanceSpan = document.createElement('span');
                    advanceSpan.textContent = ' ✓';
                    advanceSpan.style.fontWeight = 'bold';
                    advanceSpan.style.color = 'var(--success)';
                    playerDiv.appendChild(advanceSpan);
                }
            }

            return playerDiv;
        }

        /**
         * Handle player click to advance to next round
         */
        function handlePlayerClick(event) {
            const matchNumber = parseInt(event.currentTarget.dataset.matchNumber);
            const playerSlot = parseInt(event.currentTarget.dataset.playerSlot);

            const match = currentDraw.matches.find(m => m.matchNumber === matchNumber);
            if (!match) return;

            // Get the selected player
            const selectedPlayer = playerSlot === 1 ? match.player1 : match.player2;

            // Set as manual winner
            match.manualWinner = selectedPlayer;

            // Advance to next round
            if (match.nextMatch) {
                const nextMatch = currentDraw.matches.find(m => m.matchNumber === match.nextMatch);
                if (nextMatch) {
                    // Determine which slot in next match (odd matches feed into player1, even into player2)
                    const feedsIntoPlayer1 = (matchNumber % 2 === 1);

                    if (feedsIntoPlayer1) {
                        nextMatch.player1 = selectedPlayer;
                    } else {
                        nextMatch.player2 = selectedPlayer;
                    }
                }
            }

            // Redraw the bracket
            displayBracket();
        }

        // ============================================
        // EXPORT FUNCTIONS
        // ============================================

        /**
         * Export as JSON
         */
        function exportJSON() {
            if (!currentDraw) return;

            const dataStr = JSON.stringify(currentDraw, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);

            const link = document.createElement('a');
            link.href = url;
            link.download = `cup-draw-${Date.now()}.json`;
            link.click();

            URL.revokeObjectURL(url);
            showAlert('Draw exported as JSON.', 'success');
        }

        /**
         * Export as CSV
         */
        function exportCSV() {
            if (!currentDraw) return;

            let csv = 'Match Number,Round,Player 1,Seed 1,Player 2,Seed 2,Best of,Next Match,Auto Advance\n';

            for (let match of currentDraw.matches) {
                const p1Name = match.player1 ? match.player1.name : 'TBD';
                const p1Seed = match.player1 && match.player1.seed ? match.player1.seed : '';
                const p2Name = match.player2 ? match.player2.name : 'TBD';
                const p2Seed = match.player2 && match.player2.seed ? match.player2.seed : '';
                const nextMatch = match.nextMatch || 'None';
                const autoAdvance = match.winner ? match.winner.name : '';

                csv += `${match.matchNumber},${match.round},"${p1Name}",${p1Seed},"${p2Name}",${p2Seed},${match.matchLength},${nextMatch},"${autoAdvance}"\n`;
            }

            const dataBlob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(dataBlob);

            const link = document.createElement('a');
            link.href = url;
            link.download = `cup-draw-${Date.now()}.csv`;
            link.click();

            URL.revokeObjectURL(url);
            showAlert('Draw exported as CSV.', 'success');
        }

        // ============================================
        // UI FUNCTIONS
        // ============================================

        /**
         * Clear form
         */
        function clearForm() {
            document.getElementById('entrants').value = '';
            document.getElementById('seeds').value = '';
            document.getElementById('alertContainer').innerHTML = '';
        }

        /**
         * Show setup section
         */
        function showSetup() {
            document.getElementById('setupSection').classList.remove('hidden');
            document.getElementById('resultsSection').classList.add('hidden');
            document.getElementById('bracketSection').classList.add('hidden');
        }

        /**
         * Reset all match results (clear manual winners)
         */
        function resetResults() {
            if (!currentDraw) return;

            if (!confirm('Are you sure you want to reset all match results? This will clear all winners and return to the initial draw.')) {
                return;
            }

            // Clear all manual winners
            for (let match of currentDraw.matches) {
                match.manualWinner = null;

                // Reset players in rounds 2-6 to null (except auto-advances from BYEs)
                if (match.matchNumber >= 33) {
                    match.player1 = null;
                    match.player2 = null;
                }
            }

            // Re-propagate auto-advances from BYEs
            propagateAutoAdvances(currentDraw.matches);

            // Redraw bracket
            displayBracket();

            showAlert('All match results have been reset.', 'success');
        }

        /**
         * Load sample data
         */
        function loadSampleData() {
            const sampleEntrants = [
                'John Smith',
                'Jane Doe',
                'Mike Johnson',
                'Sarah Williams',
                'David Brown',
                'Emma Wilson',
                'James Taylor',
                'Emily Davis',
                'Robert Miller',
                'Lisa Anderson',
                'Michael Thomas',
                'Jennifer Jackson',
                'William White',
                'Mary Harris',
                'Richard Martin',
                'Patricia Thompson'
            ];

            const sampleSeeds = [
                'John Smith=1',
                'Jane Doe=2',
                'Mike Johnson=3',
                'Sarah Williams=4',
                'David Brown=5',
                'Emma Wilson=6',
                'James Taylor=7',
                'Emily Davis=8'
            ];

            document.getElementById('entrants').value = sampleEntrants.join('\n');
            document.getElementById('seeds').value = sampleSeeds.join('\n');

            showAlert('Sample data loaded. Click "Generate Draw" to create bracket.', 'success');
        }

        // ============================================
        // NAVIGATION
        // ============================================

        document.addEventListener('DOMContentLoaded', function() {
            const mobileToggle = document.querySelector('.mobile-toggle');
            const navMenu = document.querySelector('.nav-menu');
            const dropdownToggles = document.querySelectorAll('.dropdown-toggle');

            // Toggle mobile menu
            if (mobileToggle) {
                mobileToggle.addEventListener('click', function() {
                    navMenu.classList.toggle('active');
                    this.classList.toggle('active');

                    const bars = this.querySelectorAll('.bar');
                    if (this.classList.contains('active')) {
                        bars[0].style.transform = 'rotate(-45deg) translate(-5px, 6px)';
                        bars[1].style.opacity = '0';
                        bars[2].style.transform = 'rotate(45deg) translate(-5px, -6px)';
                    } else {
                        bars[0].style.transform = 'none';
                        bars[1].style.opacity = '1';
                        bars[2].style.transform = 'none';
                    }
                });
            }

            // Handle dropdown menus on mobile
            dropdownToggles.forEach(toggle => {
                toggle.addEventListener('click', function(e) {
                    if (window.innerWidth <= 768) {
                        e.preventDefault();
                        const parentLi = this.parentElement;

                        document.querySelectorAll('.dropdown.active').forEach(item => {
                            if (item !== parentLi) {
                                item.classList.remove('active');
                            }
                        });

                        parentLi.classList.toggle('active');
                    }
                });
            });

            // Close menu when clicking outside
            document.addEventListener('click', function(e) {
                if (navMenu && mobileToggle) {
                    const isClickInsideNav = navMenu.contains(e.target) || mobileToggle.contains(e.target);
                    if (!isClickInsideNav && navMenu.classList.contains('active')) {
                        navMenu.classList.remove('active');
                        mobileToggle.classList.remove('active');
                        const bars = mobileToggle.querySelectorAll('.bar');
                        bars[0].style.transform = 'none';
                        bars[1].style.opacity = '1';
                        bars[2].style.transform = 'none';
                    }
                }
            });

            // Handle resize events
            window.addEventListener('resize', function() {
                if (window.innerWidth > 768 && navMenu) {
                    navMenu.classList.remove('active');
                    if (mobileToggle) {
                        mobileToggle.classList.remove('active');
                        const bars = mobileToggle.querySelectorAll('.bar');
                        bars[0].style.transform = 'none';
                        bars[1].style.opacity = '1';
                        bars[2].style.transform = 'none';
                    }

                    document.querySelectorAll('.dropdown.active').forEach(item => {
                        item.classList.remove('active');
                    });
                }
            });
        });
    </script>
</body>
</html>
